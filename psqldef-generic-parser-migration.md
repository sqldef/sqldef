# Generic Parser Migration

## Goal

We are implementing PostgreSQL syntaxes in the generic parser. Once the migration is complete, we will discard the `pgquery` parser.

## Current Status

- **DONE 1006 tests, 25 failures** (`PSQLDEF_PARSER=generic make test-psqldef`)
  - Fixed since last update: `LongAutoGeneratedCheckConstraint` (constraint name truncation algorithm)

## Rules

* Keep this document up to date. Don't keep the completed tasks
* Do not modify tests in this migration process. No breaking changes are allowed
* Do not change the behavior by checking `PSQLDEF_PARSER`, which will be removed away after the migration
* `pgquery` parser might normalize AST in a wrong way, which should be fixed in this migration process (commit cadcee36b9ed3fbb1a185262cc8881ca53d409d4 for example)

## Remaining Tasks

### Summary

The 24 remaining test failures (25 including TestApply wrapper) fall into these categories:

1. **Auto-generated Constraint Names** - 1 item causing ~1 failure
2. **Comment Statement Issues** - 2 items causing ~4 failures
3. **Foreign Key Issues** - Multiple items causing ~6 failures
4. **Array Default Issues** - 1 item causing ~3 failures
5. **Check Constraint Issues** - 1 item causing ~2 failures
6. **Managed Roles Issues** - 1 item causing ~2 failures
7. **Miscellaneous** - Various items causing ~6 failures

Note: Many tests have multiple issues, so the counts overlap.

### Auto-generated Constraint Names

1. **Long foreign key constraint names** - PostgreSQL truncates to 63 characters
   - Parser generates different constraint names than PostgreSQL for very long names
   - Affects: `LongAutoGeneratedForeignKeyConstraint`
   - Fix: Already implemented in util/postgres_util.go, may need verification for edge cases
   - âœ… Related fix: `LongAutoGeneratedCheckConstraint` now passes

### Comment Statement Issues

1. **COMMENT schema qualification** - Missing schema prefix in COMMENT statements
   - Generated: `COMMENT ON TABLE users IS ...`
   - Expected: `COMMENT ON TABLE public.users IS ...`
   - Affects: `CommentUnset`, `CommentWithoutSchema`, `CommentWithoutSchemaWithoutTableNameQuoted`, `CommentWithoutSchemaWithTableNameQuoted`
   - Fix: Always include schema prefix in COMMENT statements

2. **COMMENT IS NULL not generated** - Comment removal statements not output
   - When comments need to be removed, should generate: `COMMENT ON TABLE table IS NULL;`
   - Currently generates: nothing (empty string)
   - Affects: `CommentUnset`
   - Fix: Detect when comments are removed and generate COMMENT ... IS NULL statements

### Foreign Key Issues

1. **Inline foreign key without column specification** - Empty reference columns
   - Syntax: `REFERENCES table` (without column list)
   - Parser creates foreign key with empty referenceColumns array
   - Database infers primary key, but comparison fails during idempotency check
   - Affects: `CreateTableWithReferences`, `DropReferences`, `CreateTableAddAbsentForeignKey`, `ForeignKeyOnReservedName`, `ViewWithDistinct`, `ViewWithGroupByAndHaving`
   - Fix: Handle implicit reference columns in comparison or lookup primary key during parsing

2. **Foreign key dependency ordering** - Circular dependencies not handled
   - Foreign keys need to be created in correct order
   - Affects: `ForeignKeyConstraintsAreEmittedLast`, `ForeignKeyDependenciesCircular`
   - Fix: Implement topological sort for foreign key creation

3. **Foreign key ON DELETE/UPDATE clauses** - Missing or incorrect clauses
   - Affects: `ReferencesWithOnDeleteCascade`
   - Fix: Ensure ON DELETE/UPDATE clauses are properly parsed and generated

### Array Default Issues

1. **Multi-dimensional array defaults** - Not handled correctly
   - Array defaults with multiple dimensions or empty arrays
   - Affects: `ChangeMultiDimensionalArrayDefault`, `MultiDimensionalArrayWithDefaultEmpty`
   - Fix: Parse and generate multi-dimensional array defaults correctly

### Check Constraint Issues

1. **Check constraint with typed literals and casts** - Not handled correctly
   - Check constraints with complex type casts and literal formats
   - Affects: `CheckConstraint`, `TypedLiteralsInCheckWithCast`
   - Fix: Normalize typed literals and cast expressions in CHECK constraints

### Managed Roles Issues

1. **Managed roles error handling** - CASCADE and GRANT OPTION not properly validated
   - When using managed roles, certain grant operations should error
   - Affects: `ManagedRolesErrorCascade`, `ManagedRolesErrorGrantOption`
   - Fix: Implement proper validation for managed roles feature

### Miscellaneous

1. **Default expression with addition** - Expression not normalized
   - Affects: `ChangeDefaultExpressionWithAddition`
   - Fix: Normalize arithmetic expressions in defaults

2. **Constraint options** - DEFERRABLE/NOT DEFERRABLE not handled correctly
   - Affects: `CreateTableWithConstraintOptions`
   - Fix: Parse and generate constraint options correctly (may be related to FK issues)

3. **Negative default numbers** - Not parsed correctly
   - Affects: `NegativeDefaultNumbers`
   - Fix: Handle negative numbers in default values

4. **Default values in CREATE TABLE** - Not idempotent
   - Affects: `CreateTableWithDefault`
   - Fix: Normalize default value representation

5. **Multiple types with multiple tables** - Complex schema not handled
   - Affects: `CreateMultipleTypesWithMultipleTables`
   - Fix: Handle CREATE TYPE and CREATE TABLE in complex schemas
