# Generic Parser Migration

## Goal

We are implementing PostgreSQL syntaxes in the generic parser. Once the migration is complete, we will discard the `pgquery` parser.

## Current Status

- **DONE 1006 tests, 102 failures** (`PSQLDEF_PARSER=generic make test-psqldef`)

## Rules

* Keep this document up to date. Don't keep the completed tasks
* Do not modify tests in this migration process. No breaking changes are allowed
* Do not change the behavior by checking `PSQLDEF_PARSER`, which will be removed away after the migration
* `pgquery` parser might normalize AST in a wrong way, which should be fixed in this migration process (commit cadcee36b9ed3fbb1a185262cc8881ca53d409d4 for example)

## Remaining Tasks

### Summary

The 102 test failures fall into these categories:

1. **Type Normalization** - 3 items causing ~10 failures
2. **Expression Normalization** - 3 items causing ~30 failures
3. **View Normalization** - 1 item causing ~9 failures
4. **Keyword Case Sensitivity** - 1 item causing ~17 failures
5. **Auto-generated Constraint Names** - 1 item causing ~2 failures
6. **Comment Statement Issues** - 2 items causing ~4 failures
7. **Foreign Key Issues** - Multiple items causing ~7 failures
8. **Array Default Issues** - 1 item causing ~3 failures
9. **Miscellaneous** - Various items causing ~4 failures
10. **Integration Test Failures** - 16 tests failing due to INFO log output

Note: Many tests have multiple issues, so the counts overlap.

### Type Normalization

1. **Integer type aliases** - Generic parser outputs "int" but PostgreSQL normalizes to "integer"
   - All ADD COLUMN statements with int/integer type
   - Affects: `ForeignKeyDependenciesMultipleToModifiedTable`, `ForeignKeyDependenciesPrimaryKeyChange`, `ForeignKeyDependenciesCascadeOptionsPreservation`
   - Fix: Normalize "int" → "integer" in generator output

2. **Timestamp and time type aliases** - Generic parser outputs short forms
   - Parser outputs: `timestamptz`, `timetz`
   - PostgreSQL expects: `timestamp WITH TIME ZONE`, `time WITH TIME ZONE`
   - Also affects: `timestamp` vs `timestamp WITHOUT TIME ZONE`
   - Affects: `ChangeTimezoneSyntax`, `AddTimestamptzColumnOnNonStandardDefaultSchema`, `AddTimetzColumnOnNonStandardDefaultSchema`
   - Fix: Always output long form with explicit WITH/WITHOUT TIME ZONE

3. **Enum type schema qualification** - Missing or incorrect schema prefix
   - Example: `country` vs `public.country` vs `foo.lang`
   - Parser doesn't preserve or normalize schema qualification
   - Affects: `CreateTypeEnum`, `AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema`, `CreateMultipleTypesWithMultipleTables`
   - Fix: Always include schema prefix when outputting enum types

### Expression Normalization

1. **CHECK constraints with IN/ANY/SOME/ALL** - Different representations not normalized
   - PostgreSQL converts: `IN (1,2,3)` → `= ANY (ARRAY[1,2,3])`
   - PostgreSQL preserves: `= SOME (ARRAY[...])`, `= ALL (ARRAY[...])`
   - Generic parser outputs original form, causing mismatch
   - Affects: ~15 tests including `ConstraintCheckInModify`, `ParseAllAnyCheckConstraint`, `SomeConstraintModificationsSomeToAll`
   - Fix: Normalize all forms consistently or parse PostgreSQL's normalized form

2. **Typed literal defaults** - Type prefix in default values
   - PostgreSQL adds type prefix: `date '2024-01-01'` instead of `'2024-01-01'`
   - Affects: `TypedLiterals`, `TypedLiteralsChangeDefault`, `TypedLiteralsIdempotency`
   - Fix: Parse and normalize typed literals (date/time/timestamp prefixes)

3. **EXCLUDE constraint normalization** - Missing USING clause or other parts
   - Example: `EXCLUDE (name WITH =)` vs `EXCLUDE USING GIST (name WITH =)`
   - PostgreSQL adds default USING method
   - Affects: `ExcludeConstraintDropAndAdd`, `ExcludeConstraintChange`, `ExcludeConstraintWithAlterTable`
   - Fix: Parse and output complete EXCLUDE constraint syntax

### View Normalization

1. **VIEW definition normalization** - Views not idempotent after creation
   - PostgreSQL normalizes view definitions (adds casts, rewrites expressions, etc.)
   - Generic parser doesn't normalize to match PostgreSQL's output
   - Affects: ~8 tests including `ViewDDLsAreEmittedLastWithoutChangingDefinition`, `ViewWithGroupByAndHaving`, `CreateViewCast`
   - Fix: Either normalize views in generic parser or fetch normalized definition from database

### Keyword Case Sensitivity

1. **GRANT privilege keywords** - Case mismatch in output
   - Expected: `GRANT SELECT ...` (uppercase)
   - Actual: `GRANT select ...` (lowercase)
   - Affects: `ManagedRolesSpecialCharacters` and ~12 other managed roles tests
   - Fix: Normalize privilege keywords to uppercase in generator

### Auto-generated Constraint Names

1. **Long constraint names** - PostgreSQL truncates to 63 characters differently
   - Parser generates different constraint names than PostgreSQL
   - Affects: `LongAutoGeneratedCheckConstraint`, `LongAutoGeneratedForeignKeyConstraint`
   - Fix: Implement PostgreSQL's constraint name generation algorithm

### Comment Statement Issues

1. **COMMENT schema qualification** - Missing schema prefix in COMMENT statements
   - Generated: `COMMENT ON TABLE users IS ...`
   - Expected: `COMMENT ON TABLE public.users IS ...`
   - Affects: `CommentUnset`, `CommentWithoutSchema`, `CommentWithoutSchemaWithoutTableNameQuoted`, `CommentWithoutSchemaWithTableNameQuoted`
   - Fix: Always include schema prefix in COMMENT statements

2. **COMMENT IS NULL not generated** - Comment removal statements not output
   - When comments need to be removed, should generate: `COMMENT ON TABLE table IS NULL;`
   - Currently generates: nothing (empty string)
   - Affects: `CommentUnset`
   - Fix: Detect when comments are removed and generate COMMENT ... IS NULL statements

### Foreign Key Issues

1. **Inline foreign key without column specification** - Empty reference columns
   - Syntax: `REFERENCES table` (without column list)
   - Parser creates foreign key with empty referenceColumns array
   - Database infers primary key, but comparison fails during idempotency check
   - Affects: `CreateTableWithReferences`, `DropReferences`, `CreateTableAddAbsentForeignKey`, `ForeignKeyOnReservedName`
   - Fix: Handle implicit reference columns in comparison or lookup primary key during parsing

2. **Foreign key dependency ordering** - Circular dependencies not handled
   - Foreign keys need to be created in correct order
   - Affects: `ForeignKeyConstraintsAreEmittedLast`, `ForeignKeyDependenciesCircular`
   - Fix: Implement topological sort for foreign key creation

3. **Foreign key ON DELETE/UPDATE clauses** - Missing or incorrect clauses
   - Affects: `ReferencesWithOnDeleteCascade`
   - Fix: Ensure ON DELETE/UPDATE clauses are properly parsed and generated

### Array Default Issues

1. **Multi-dimensional array defaults** - Not handled correctly
   - Array defaults with multiple dimensions or empty arrays
   - Affects: `AddMultiDimensionalArrayColumn`, `ChangeMultiDimensionalArrayDefault`, `MultiDimensionalArrayWithDefaultEmpty`
   - Fix: Parse and generate multi-dimensional array defaults correctly

### Miscellaneous

1. **Default expression with addition** - Expression not normalized
   - Affects: `ChangeDefaultExpressionWithAddition`
   - Fix: Normalize arithmetic expressions in defaults

2. **Boolean expressions in indexes** - Not handled correctly
   - Affects: `CreateIndexWithBoolExpr`
   - Fix: Parse and generate boolean expressions in CREATE INDEX

3. **Constraint options** - DEFERRABLE/NOT DEFERRABLE not handled
   - Affects: `CreateTableWithConstraintOptions`
   - Fix: Parse and generate constraint options correctly

4. **Negative default numbers** - Not parsed correctly
   - Affects: `NegativeDefaultNumbers`
   - Fix: Handle negative numbers in default values

5. **Default values in CREATE TABLE** - Not idempotent
   - Affects: `CreateTableWithDefault`
   - Fix: Normalize default value representation

### Integration Test Failures

All integration tests are failing due to the INFO log message being included in output:
- `TestPsqldefBeforeApply`
- `TestPsqldefConfigIncludesSkipTables`
- `TestPsqldefConfigIncludesSkipViews`
- `TestPsqldefConfigIncludesTargetSchema`
- `TestPsqldefConfigIncludesTargetSchemaWithViews`
- `TestPsqldefConfigIncludesTargetTables`
- `TestPsqldefConfigInlineEnableDrop`
- `TestPsqldefDropTable`
- `TestPsqldefExport`
- `TestPsqldefExportCompositePrimaryKey`
- `TestPsqldefExportConcurrency`
- `TestPsqldefIgnoreExtension`
- `TestPsqldefReindexConcurrently`
- `TestPsqldefSkipExtension`
- `TestPsqldefSkipView`
- `TestPsqldefTransactionBoundariesWithConcurrentIndex`

Fix: Suppress INFO log when `PSQLDEF_PARSER=generic` is set, or update tests to expect the log message
