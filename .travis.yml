language: go
go:
  - '1.10'
branches:
  only:
    - master
    - /\Av\d+\.\d+\.\d+\z/
services:
  - mysql
  - postgresql
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server
      - mysql-client
before_install:
  - sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('new_password') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
  - sudo mysql_upgrade -u root -pnew_password
  - sudo service mysql restart
  - sudo mysqladmin -u root -pnew_password password ''
script:
  - make test
before_deploy:
  - make package
deploy:
  provider: releases
  api_key:
    # This is generated by `travis setup releases -r k0kubun/sqldef`
    secure: RDRdNA6AepoyWgWt13E5RphyXL2GNGSmfrtEOeY6u+DKynhyV+zO980a0H/IERk+1R+A8nYFVhOCcGp1bs4qorJCDPcOyOrngRH4GzmfsGOW+TXB62ICKsrBQg7mvv/ZPPjSKcIeonyV6aysj+R0neUZtACCnrCyybz5Mo4eRWw0vMynbXLfKWsfIz3jI5OvX1QG3hf2EUQ4V9FfeerpiZXkEb9Qhdns4GJki1GtPyQqnU+4MLYpk095dpCYrl+ybaxfkaMRxK5hRYAb+8MPf/lWGL7h1cPhG3hjdBQonCIQVIBYWSGVYivmQ7zA8iU/gtrz85unWJR8fT4Z4yfLmrauHmZXlCmKcAFZC14pzTj59CDuCyNup5Yp7PK6LKZRPPfs6caU/VefORkzem2eoZ6E0FMg+mrxbC1SNsBl9OurxYD8s5uzJZViWHmQK+/okNBu4SWP3BLJ7lS9gu7JEFyYHYPc32vTpq7k4ZhaSf870KBE49GGo1K5/sH2uabdVaO5xpfCRoxK2BeIaOw5Y859fQvcB6pfJYd8FN3tdJQUvbHMOaQyWPLq115+holeA7Gg5KsAhas34wclVplaM83zDiLnrSHTdgNoeynFarK4BuqjttUNyAWlDMEk5vy6OBVPDr/cGtwEmJWIrnsNqwgbcKnXbqrC4HP7FkQ5HBg=
  file_glob: true
  file: package/*
  skip_cleanup: true
  on:
    repo: k0kubun/sqldef
    tags: true
