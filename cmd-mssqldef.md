# mssqldef

```
Usage:
  mssqldef [OPTIONS] [database|current.sql] < desired.sql

Application Options:
  -U, --user=user_name        MSSQL user name (default: sa)
  -P, --password=password     MSSQL user password, overridden by $MSSQL_PWD
  -h, --host=host_name        Host to connect to the MSSQL server (default: 127.0.0.1)
  -p, --port=port_num         Port used for the connection (default: 1433)
      --password-prompt       Force MSSQL user password prompt
      --file=sql_file         Read desired SQL from the file, rather than stdin (default: -)
      --dry-run               Don't run DDLs but just show them
      --export                Just dump the current schema to stdout
      --enable-drop           Enable destructive changes such as DROP for TABLE, SCHEMA, ROLE, USER, FUNCTION, PROCEDURE, TRIGGER, VIEW, INDEX, SEQUENCE, TYPE
      --config=config.yml     YAML file to specify configuration options (can be specified multiple times)
      --config-inline=YAML    YAML string to specify configuration options (can be specified multiple times)
      --help                  Show this help
      --version               Show this version
```

## Synopsis

```shell
# Export current schema
$ mssqldef -U sa -P password123 mydb --export
CREATE TABLE dbo.users (
    id INT IDENTITY(1,1) PRIMARY KEY,
    name NVARCHAR(255) NOT NULL
);

# Save it to edit
$ mssqldef -U sa -P password123 mydb --export > schema.sql
```

Update schema.sql as follows:

```diff
 CREATE TABLE dbo.users (
     id INT IDENTITY(1,1) PRIMARY KEY,
-    name NVARCHAR(255) NOT NULL
+    name NVARCHAR(255) NOT NULL,
+    email NVARCHAR(320) NOT NULL,
+    created_at DATETIME2 DEFAULT GETDATE()
 );
+
+CREATE INDEX IX_users_email ON dbo.users(email);
```

And then run:

```shell
# Preview migration plan (dry run)
$ mssqldef -U sa -P password123 mydb --dry-run < schema.sql
-- dry run --
BEGIN TRANSACTION;
ALTER TABLE dbo.users ADD email NVARCHAR(320) NOT NULL;
ALTER TABLE dbo.users ADD created_at DATETIME2 DEFAULT GETDATE();
CREATE INDEX IX_users_email ON dbo.users(email);
COMMIT;

# Apply DDLs
$ mssqldef -U sa -P password123 mydb < schema.sql
-- Apply --
BEGIN TRANSACTION;
ALTER TABLE dbo.users ADD email NVARCHAR(320) NOT NULL;
ALTER TABLE dbo.users ADD created_at DATETIME2 DEFAULT GETDATE();
CREATE INDEX IX_users_email ON dbo.users(email);
COMMIT;

# Operations are idempotent - safe to run multiple times
$ mssqldef -U sa -P password123 mydb < schema.sql
-- Nothing is modified --

# Run without dropping tables and columns
$ mssqldef -U sa -P password123 mydb < schema.sql
-- Skipped: DROP TABLE dbo.old_users;

# Run with drop operations enabled
$ mssqldef -U sa -P password123 mydb --enable-drop < schema.sql
-- Apply --
BEGIN TRANSACTION;
DROP TABLE dbo.old_users;
COMMIT;

# Use config file to filter tables
$ cat > config.yml <<EOF
target_tables: |
  dbo\.users
  dbo\.posts_\d+
skip_tables: |
  sys\..*
  temp_.*
EOF
$ mssqldef -U sa -P password123 mydb --config=config.yml < schema.sql

# Use inline YAML configuration
$ mssqldef -U sa -P password123 mydb --config-inline="skip_tables: backup_.*" < schema.sql

# Multiple configs (later values override earlier ones)
$ mssqldef -U sa -P password123 mydb --config=base.yml --config-inline="target_tables: dbo\..*" < schema.sql
```

## Supported features

The following DDLs are generated by updating `CREATE TABLE`.
Some can also be used in the input schema.sql file.

- Table: CREATE TABLE, DROP TABLE
- Column: ADD COLUMN, DROP COLUMN, DROP CONSTRAINT
- Index: ADD INDEX, DROP INDEX
- Primary key: ADD PRIMARY KEY, DROP PRIMARY KEY
- VIEW: CREATE VIEW, DROP VIEW

## Configuration

The `--config` and `--config-inline` options accept YAML configuration with the following fields:

| Field | Type | Description |
|-------|------|-------------|
| `target_tables` | string | Regular expression patterns (one per line) to specify which tables to manage. Only tables matching these patterns will be processed. |
| `skip_tables` | string | Regular expression patterns (one per line) to specify which tables to skip. Tables matching these patterns will be ignored. |
