# TODO: Migration from pgquery to generic parser

This document tracks the progress of migrating from `pgquery` to `generic` parser.

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but never modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* When you add `slog.Debug()` for debugging, you don't need to remove them after the task is done.
* Use AST as much as possible, instead of string manipulation.
* Keep `TODO.md` up-to-date, just removing completed tasks, instead of marking them as done.

## Test

`PSQLDEF_PARSER=generic` to use the generic parser. `PSQLDEF_PARSER=pgquery` to use the pgquery parser. Otherwise, `psqldef` uses `generic` as the primary parser, and the `pgquery` as the fallback.

Eventually, both `PSQLDEF_PARSER=generic make test-psqldef` and `PSQLDEF_PARSER=pgquery make test-psqldef` must pass, as well as `make test-mysqldef`, `make test-sqlite3def`, `make test-mssqldef`.

## Current Test Status

### Default Parser (generic primary, pgquery fallback) - 3 tests fail
When running with default parser:

1. **TestApply/CreateViewWithCaseWhen** - View idempotency: parenthesization differences in complex expressions
2. **TestApply/LongAutoGeneratedForeignKeyConstraint** - Foreign key constraint name generation (PostgreSQL's 63-char truncation)
3. **TestApply/CreateTableWithConstraintOptions** - Constraint options idempotency issues

### GENERIC Parser (PSQLDEF_PARSER=generic) - 3 tests fail
When running with `PSQLDEF_PARSER=generic`:

1. **TestApply/CreateViewWithCaseWhen** - View idempotency: parenthesization differences in complex expressions
2. **TestApply/LongAutoGeneratedForeignKeyConstraint** - Foreign key constraint name generation (PostgreSQL's 63-char truncation)
3. **TestApply/CreateTableWithConstraintOptions** - Constraint options idempotency issues

**Root causes of remaining failures**:
- View formatting differences between pg_get_viewdef() and parser output (CAST vs :: syntax, parenthesization)
- Foreign key constraint name truncation: PostgreSQL uses a smart truncation algorithm when names exceed 63 characters, but the generic parser doesn't replicate this exactly
- Constraint options idempotency: Some issues with how constraint options are compared after being applied

## Priority Issues to Fix

### High Priority - Generic Parser
1. **View idempotency** (PARTIALLY FIXED) - CASE WHEN views get dropped/recreated on each apply
   - String literal ::text casts now normalized âœ…
   - Remaining issue: Parenthesization and CAST vs :: syntax differences in complex expressions
   - Example: `to_timestamp(((expr))::bigint)` (from DB) vs `(to_timestamp(expr::bigint))` (from parser)
   - Root cause: pg_get_viewdef() returns different formatting than generic parser generates
   - Requires: Better AST normalization or accept functional equivalence
2. **Foreign key constraint name generation** - Auto-generated names for long foreign keys
3. **Constraint options** - DEFERRABLE and INITIALLY DEFERRED options not properly compared

### Medium Priority - Generic Parser
1. **CREATE EXTENSION** - Extension creation not supported (`CREATE EXTENSION citext;`)

