# TODO: Migration from pgquery to generic parser

This document tracks the progress of migrating from `pgquery` to `generic` parser.

**Status: Active development - Multiple parser issues identified**
**Goal: Both `make test-psqldef` and `PSQLDEF_PARSER=generic make test-psqldef` should pass**

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but never modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* When you add `slog.Debug()` for debugging, you don't need to remove them after the task is done.
* Keep `TODO.md` up-to-date, just removing completed tasks, instead of marking them as done.

## Test

`PSQLDEF_PARSER=generic` to use the generic parser. Otherwise, `psqldef` uses `pgquery` as the primary parser, and the generic parser as a fallback.

Eventually, both `make test-psqldef` and `PSQLDEF_PARSER=pgquery make test-psqldef` should pass.

## Current Test Status (as of 2025-10-12 19:06 JST)

### PGQUERY Parser Failures (8 tests fail)
When running with default parser (pgquery with generic fallback):

1. **TestPsqldefCreateTableWithIdentityColumn** - IDENTITY column support issue: `pq: column "color_id" of relation "color" is an identity column`
2. **TestPsqldefAddingIdentityColumn** - IDENTITY column support issue: `pq: syntax error at or near ")"`
3. **TestPsqldefRemovingIdentityColumn** - IDENTITY column support issue: `pq: column "color_id" of relation "color" is an identity column`
4. **TestPsqldefChangingIdentityColumn** - IDENTITY column support issue: `pq: column "color_id" of relation "color" is an identity column`
5. **TestPsqldefCreateIdentityColumnWithSequenceOption** - IDENTITY column support issue: `pq: column "volt" of relation "voltages" is an identity column`
6. **TestPsqldefModifyIdentityColumnWithSequenceOption** - IDENTITY column support issue: `pq: column "volt" of relation "voltages" must be declared NOT NULL before identity can be added`
7. **TestPsqldefAddIdentityColumnWithSequenceOption** - IDENTITY column support issue: `pq: column "volt" of relation "voltages" is an identity column`
8. **TestPsqldefConfigIncludesSkipViews** - WARN logs in output (passes with `LOG_LEVEL=error`)

**Root cause**: pgquery doesn't support IDENTITY syntax, falls back to generic parser but generates incorrect ALTER statements

### GENERIC Parser Failures (11 tests fail)
When running with `PSQLDEF_PARSER=generic`:

1. **TestApply/CreateTableWithDefault** - Array default idempotency issues: `'{}'::int[]` vs `'{}'::integer[]`, `ARRAY[]` formatting
2. **TestApply/CreateTableWithDefaultContainingQuote** - String quote escaping idempotency issue: `'it''s free real estate'`
3. **TestApply/CreateViewWithCaseWhen** - View idempotency issue: view gets dropped and recreated on each apply
4. **TestApply/CreateIndexConcurrently** - CONCURRENTLY keyword handling
5. **TestApply/CheckConstraint** - Missing constraints in initial apply + idempotency issues
6. **TestApply/LongAutoGeneratedForeignKeyConstraint** - Long FK constraint names
7. **TestApply/AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema** - ENUM type with schema
8. **TestApply/ExcludeConstraintWithCreateTable** - EXCLUDE constraint parsing
9. **TestApply/IndexesOnChangedExpressions** - Expression index handling
10. **TestPsqldefCitextExtension** - Extension handling: `CREATE EXTENSION citext;` syntax error
11. **TestPsqldefCreateType** - ENUM type parsing error when used as column type: `country "public"."country"`

**Root causes**:
- Idempotency issues from AST comparison problems (arrays, quotes, views)
- Missing PostgreSQL-specific syntax support (EXTENSION, EXCLUDE, CONCURRENTLY)
- ENUM type parsing issues

## Priority Issues to Fix

### High Priority - Generic Parser
1. **Array defaults idempotency** - Type normalization issues (`int[]` vs `integer[]`), `ARRAY[]` constructor formatting differences
2. **String quote escaping idempotency** - Single quotes in strings (`'it''s'`) parsing/comparison issue
3. **CHECK constraints parsing** - Some constraints not parsed correctly (missing in initial apply)
4. **ENUM type usage** - Parse error when ENUM type used as column type: `country "public"."country"`
5. **View idempotency** - CASE WHEN views get dropped/recreated on each apply

### High Priority - PGQUERY Parser
1. **IDENTITY column DDL generation** - Falls back to generic parser but generates incorrect ALTER statements (7 tests failing)
2. **Materialized view warnings** - Creates noise in test output (workaround: `LOG_LEVEL=error`)

### Medium Priority - Generic Parser
1. **CREATE EXTENSION** - Extension creation not supported (`CREATE EXTENSION citext;`)
2. **CONCURRENTLY keyword** - For CREATE INDEX CONCURRENTLY
3. **Expression indexes** - Indexes on expressions not properly handled
4. **EXCLUDE constraints** - EXCLUDE constraint syntax not supported
5. **Long constraint names** - Foreign key constraint name handling
6. **ENUM type with schema** - ENUM columns with explicit schema on non-standard default schema

## Completed Fixes

### Type Normalization (int vs integer) ✅
- Normalized all representations to `integer` (PostgreSQL canonical type name)
- Modified `database/postgres/database.go`, `database/postgres/parser.go`, `schema/generator.go`
- All IDENTITY column tests now pass with `PSQLDEF_PARSER=generic`

### Basic Type Support ✅
1. **BPCHAR type** - Added to `simple_convert_type` for `'JPN'::bpchar`
2. **JSON/JSONB types** - Added to `simple_convert_type` for `'{}'::json`
3. **TIMESTAMP types** - Added `timestamp with/without time zone` support

### Nested Typecast Parsing ✅ (2025-10-12)
**Problem**: Parser failed on nested typecasts like `((CURRENT_TIMESTAMP)::date)::text`
- Error: "syntax error near '::'" at the second typecast operator
- Affected DEFAULT clauses and any parenthesized typecast expressions

**Root Cause**: Grammar rule `DEFAULT '(' value_expression ')'` in `parser/parser.y` at line 2302
- This rule explicitly matched `DEFAULT (expr)` and consumed the parentheses
- Prevented parenthesized expressions from being used in larger expressions
- Example: `DEFAULT (expr)::type` would parse `(expr)` as complete, then fail on `::type`
- Same issue with `DEFAULT (expr) + 3` - couldn't use parenthesized expr as left operand

**Solution**: Removed the problematic rule
- The first rule `DEFAULT value_expression` is sufficient
- `value_expression` includes `tuple_expression` which handles parentheses via `ParenExpr`
- Now `DEFAULT (expr)::type` correctly parses `(expr)::type` as a complete `value_expression`

**Status**: Nested typecasts now parse successfully ✅
- `(CURRENT_TIMESTAMP::date)::text` ✅
- `((CURRENT_TIMESTAMP)::date)::text` ✅
- `(1 + 2) + 3` ✅

**Known Issues**: This fix introduced idempotency problems with array defaults
- Array defaults show type normalization issues: `'{}'::int[]` vs `'{}'::integer[]`
- `ARRAY[]` constructor formatting differs between generated and parsed SQL
- These are now tracked separately as high priority issues to fix
