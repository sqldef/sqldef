# TODO: Migration from pgquery to generic parser

This document tracks the failing tests when using `PSQLDEF_PARSER=generic`.

**Total failing tests: 30**

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but do not modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* Wen you add `slog.Debug()` for debugging, you don't need to remove them after the task is done.
* Keep `TODO.md` up-to-date, just removing completed tasks, instead of marking them as done.

## Summary by Issue Type

- **Remaining failures**: 30 tests
  - GRANT/REVOKE: ~17 tests (generator/schema handling issues, not parser)
  - COMMENT: 3 tests (schema prefix handling issues, not parser)
  - Schema-related: ~3 tests (AddTimestamptzColumnOnNonStandardDefaultSchema, AddTimetzColumnOnNonStandardDefaultSchema, AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema)
  - Other: ~7 tests (CreateIndexWithBoolExpr, CreateViewWithCaseWhen, ChangeDefaultExpressionWithAddition, ChangeTimezoneSyntax, IndexesOnChangedExpressions, CreateTableWithDefault, LongAutoGeneratedForeignKeyConstraint)

## Known Pre-Existing Issues (Not Related to Generic Parser)

**MySQL**:
- `CheckDuplicateValuesInOrChain` - expects OR chain deduplication and conversion to IN (not implemented)

**SQL Server**:
- 10 CHECK constraint tests failing due to SQL Server's own normalization differences (pre-existing)

## Remaining Test Failures (30 tests)

### GRANT/REVOKE Tests (~17 tests) - Generator/Schema handling issues
- [ ] ManagedRolesAddPrivileges
- [ ] ManagedRolesAllPrivileges
- [ ] ManagedRolesBasicGrant
- [ ] ManagedRolesErrorCascade
- [ ] ManagedRolesErrorGrantOption
- [ ] ManagedRolesIgnoreUnmanagedRole
- [ ] ManagedRolesMixedGrantRevoke
- [ ] ManagedRolesMultipleGrantees
- [ ] ManagedRolesMultipleRoles
- [ ] ManagedRolesMultipleTables
- [ ] ManagedRolesOverlapping
- [ ] ManagedRolesPartialGrantees
- [ ] ManagedRolesPartialRevokeFromAll
- [ ] ManagedRolesPublic
- [ ] ManagedRolesRevoke
- [ ] ManagedRolesRevokeAll
- [ ] ManagedRolesSpecialCharacters

**Note**: Parser implementation is complete. Remaining issues are in generator/schema handling (table name formatting, schema prefix handling).

### COMMENT Tests (3 tests) - Schema prefix handling issues
- [ ] CommentWithoutSchema
- [ ] CommentWithoutSchemaWithTableNameQuoted
- [ ] CommentWithoutSchemaWithoutTableNameQuoted

**Note**: Parser implementation is complete. Issue is that schema prefix needs to be added when not explicitly provided.

### Schema-related Tests (3 tests)
- [ ] AddTimestamptzColumnOnNonStandardDefaultSchema
- [ ] AddTimetzColumnOnNonStandardDefaultSchema
- [ ] AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema

### Other TestApply Failures (7 tests)
- [ ] ChangeDefaultExpressionWithAddition - Migration output mismatch
- [ ] ChangeTimezoneSyntax - Both schemas not idempotent, timezone syntax not preserved
- [ ] CreateIndexWithBoolExpr - Desired schema not idempotent
- [ ] IndexesOnChangedExpressions - Migration output mismatch
- [ ] CreateTableWithDefault - Issue unknown
- [ ] CreateViewWithCaseWhen - Issue unknown
- [ ] LongAutoGeneratedForeignKeyConstraint - Issue unknown
