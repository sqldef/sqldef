# TODO: Migration from pgquery to generic parser

This document tracks the progress of migrating from `pgquery` to `generic` parser.

**Status: 5 of 10 tests now passing with generic parser** ‚úÖ

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but do not modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* When you add `slog.Debug()` for debugging, you don't need to remove them after the task is done.
* Keep `TODO.md` up-to-date, just removing completed tasks, instead of marking them as done.

## Progress Summary

### üìã Known Limitations (3 tests)

These issues are due to parser limitations and would require significant parser enhancements:

1. **IndexesOnChangedExpressions**
   - Issue: Parser doesn't support PostgreSQL's `VARIADIC` keyword
   - PostgreSQL normalizes: `func(a, 'b', 'c')` ‚Üí `func(a, VARIADIC ARRAY['b'::text, 'c'::text])`
   - Would require: Adding `VARIADIC` keyword support to parser grammar

2. **CreateTableWithDefault**
   - Issue: Parser doesn't recognize `bpchar` (PostgreSQL internal type name for `char`)
   - Error: "syntax error near 'bpchar'"
   - Would require: Adding `bpchar` to `simple_convert_type` grammar rule

3. **CreateViewWithCaseWhen**
   - Issue: Complex view definition normalization
   - PostgreSQL adds `::text` casts to string literals that our normalization can't fully remove
   - PostgreSQL's view formatting differs significantly from parser output
   - Would require: More aggressive view normalization or accepting PostgreSQL's formatting

### ‚è≥ Remaining Issues (2 tests)

1. **LongAutoGeneratedForeignKeyConstraint**
   - Issue: PostgreSQL identifier truncation (63-char limit) for auto-generated foreign key constraint names
   - PostgreSQL truncates differently than the generic parser expects
   - Would require: Implementing PostgreSQL's exact truncation algorithm for constraint names

2. **AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema**
   - Status: Deferred for later investigation
   - Likely related to enum type schema qualification


## Known Issues

**MySQL**:
- `CheckDuplicateValuesInOrChain` - expects OR chain deduplication and conversion to IN (not implemented)

**SQL Server**:
- 10 CHECK constraint tests failing due to SQL Server's own normalization differences (pre-existing)
