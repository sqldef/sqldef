# TODO: Migration from pgquery to generic parser

This document tracks the progress of migrating from `pgquery` to `generic` parser.

**Status: Active development - Multiple parser issues identified**
**Goal: Both `make test-psqldef` and `PSQLDEF_PARSER=generic make test-psqldef` should pass**

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but never modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* When you add `slog.Debug()` for debugging, you don't need to remove them after the task is done.
* Keep `TODO.md` up-to-date, just removing completed tasks, instead of marking them as done.

## Test

`PSQLDEF_PARSER=generic` to use the generic parser. Otherwise, `psqldef` uses `pgquery` as the primary parser, and the generic parser as a fallback.

Eventually, both `make test-psqldef` and `PSQLDEF_PARSER=pgquery make test-psqldef` should pass.

## Current Test Status (as of 2025-10-12)

### PGQUERY Parser Failures (9 tests fail)
When running with default parser (pgquery with generic fallback):

1. **TestApply/CreateIdentityColumnWithNegativeValue** - IDENTITY column support issue
2. **TestPsqldefCreateTableWithIdentityColumn** - IDENTITY column support issue
3. **TestPsqldefAddingIdentityColumn** - IDENTITY column support issue
4. **TestPsqldefRemovingIdentityColumn** - IDENTITY column support issue
5. **TestPsqldefChangingIdentityColumn** - IDENTITY column support issue
6. **TestPsqldefCreateIdentityColumnWithSequenceOption** - IDENTITY column support issue
7. **TestPsqldefModifyIdentityColumnWithSequenceOption** - IDENTITY column support issue
8. **TestPsqldefAddIdentityColumnWithSequenceOption** - IDENTITY column support issue
9. **TestPsqldefConfigIncludesSkipViews** - WARN logs in output (passes with `LOG_LEVEL=error`)

**Root cause**: pgquery doesn't support IDENTITY syntax, falls back to generic parser but generates incorrect DDL

### GENERIC Parser Failures (12 tests fail)
When running with `PSQLDEF_PARSER=generic`:

1. **TestApply/CreateTableWithDefault** - Nested typecast parsing issue: `((CURRENT_TIMESTAMP)::date)::text`
2. **TestApply/CreateTableWithDefaultContainingQuote** - String quote escaping issue: `'it''s free real estate'`
3. **TestApply/CreateViewWithCaseWhen** - View/CASE WHEN parsing issue
4. **TestApply/CreateIndexConcurrently** - CONCURRENTLY keyword handling
5. **TestApply/CheckConstraint** - CHECK constraint parsing issue
6. **TestApply/LongAutoGeneratedForeignKeyConstraint** - Long FK constraint names
7. **TestApply/AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema** - ENUM type with schema
8. **TestApply/ExcludeConstraintWithCreateTable** - EXCLUDE constraint parsing
9. **TestApply/IndexesOnChangedExpressions** - Expression index handling
10. **TestPsqldefCitextExtension** - Extension handling (CREATE EXTENSION)
11. **TestPsqldefCreateType** - CREATE TYPE AS ENUM parsing

**Root causes**: Generic parser missing support for various PostgreSQL-specific syntax

## Priority Issues to Fix

### High Priority - Generic Parser
1. **Nested typecast parsing** - `((expr)::type1)::type2` syntax not supported
2. **String quote escaping** - Single quotes in strings (`'it''s'`) not handled correctly
3. **CREATE TYPE AS ENUM** - Need to implement enum type creation
4. **CHECK constraints** - Constraint parsing issues
5. **EXCLUDE constraints** - EXCLUDE constraint syntax not supported

### High Priority - PGQUERY Parser
1. **IDENTITY column DDL generation** - Falls back to generic parser but generates incorrect ALTER statements
2. **Materialized view warnings** - Creates noise in test output (workaround: `LOG_LEVEL=error`)

### Medium Priority - Generic Parser
1. **CREATE EXTENSION** - Extension creation not supported
2. **CONCURRENTLY keyword** - For CREATE INDEX CONCURRENTLY
3. **Expression indexes** - Indexes on expressions not properly handled
4. **VIEW with CASE WHEN** - Complex view parsing
5. **Long constraint names** - Foreign key constraint name handling

## Completed Fixes

### Type Normalization (int vs integer) ✅
- Normalized all representations to `integer` (PostgreSQL canonical type name)
- Modified `database/postgres/database.go`, `database/postgres/parser.go`, `schema/generator.go`
- All IDENTITY column tests now pass with `PSQLDEF_PARSER=generic`

### Basic Type Support ✅
1. **BPCHAR type** - Added to `simple_convert_type` for `'JPN'::bpchar`
2. **JSON/JSONB types** - Added to `simple_convert_type` for `'{}'::json`
3. **TIMESTAMP types** - Added `timestamp with/without time zone` support

### Nested Typecast Parsing ✅ (2025-10-12)
**Problem**: Parser failed on nested typecasts like `((CURRENT_TIMESTAMP)::date)::text`
- Error: "syntax error near '::'" at the second typecast operator
- Affected DEFAULT clauses and any parenthesized typecast expressions

**Root Cause**: Grammar rule `DEFAULT '(' value_expression ')'` in `parser/parser.y` at line 2302
- This rule explicitly matched `DEFAULT (expr)` and consumed the parentheses
- Prevented parenthesized expressions from being used in larger expressions
- Example: `DEFAULT (expr)::type` would parse `(expr)` as complete, then fail on `::type`
- Same issue with `DEFAULT (expr) + 3` - couldn't use parenthesized expr as left operand

**Solution**: Removed the problematic rule (commented out in `parser/parser.y:2302-2307`)
- The first rule `DEFAULT value_expression` is sufficient
- `value_expression` includes `tuple_expression` which handles parentheses via `ParenExpr`
- Now `DEFAULT (expr)::type` correctly parses `(expr)::type` as a complete `value_expression`

**Status**: Nested typecasts now parse successfully ✅
- `(CURRENT_TIMESTAMP::date)::text` ✅
- `((CURRENT_TIMESTAMP)::date)::text` ✅
- `(1 + 2) + 3` ✅

**Side Effect**: May have affected AST storage for defaults - needs investigation
- Some tests show idempotency issues with array defaults
- Need to verify AST comparison still works correctly
