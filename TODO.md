# TODO: Migration from pgquery to generic parser

This document tracks the progress of migrating from `pgquery` to `generic` parser.

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but never modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* When you add `slog.Debug()` for debugging, you don't need to remove them after the task is done.
* Use AST as much as possible, instead of string manipulation.
* Keep `TODO.md` up-to-date, just removing completed tasks, instead of marking them as done.

## Test

`PSQLDEF_PARSER=generic` to use the generic parser. `PSQLDEF_PARSER=pgquery` to use the pgquery parser. Otherwise, `psqldef` uses `generic` as the primary parser, and the `pgquery` as the fallback.

Eventually, both `PSQLDEF_PARSER=generic make test-psqldef` and `PSQLDEF_PARSER=pgquery make test-psqldef` must pass, as well as `make test-mysqldef`, `make test-sqlite3def`, `make test-mssqldef`.

## Current Test Status

### PGQUERY Parser Failures (8 tests fail)
When running with default parser (pgquery with generic fallback):

1. **TestPsqldefCreateTableWithIdentityColumn** - IDENTITY column support issue: `pq: column "color_id" of relation "color" is an identity column`
2. **TestPsqldefAddingIdentityColumn** - IDENTITY column support issue: `pq: syntax error at or near ")"`
3. **TestPsqldefRemovingIdentityColumn** - IDENTITY column support issue: `pq: column "color_id" of relation "color" is an identity column`
4. **TestPsqldefChangingIdentityColumn** - IDENTITY column support issue: `pq: column "color_id" of relation "color" is an identity column`
5. **TestPsqldefCreateIdentityColumnWithSequenceOption** - IDENTITY column support issue: `pq: column "volt" of relation "voltages" is an identity column`
6. **TestPsqldefModifyIdentityColumnWithSequenceOption** - IDENTITY column support issue: `pq: column "volt" of relation "voltages" must be declared NOT NULL before identity can be added`
7. **TestPsqldefAddIdentityColumnWithSequenceOption** - IDENTITY column support issue: `pq: column "volt" of relation "voltages" is an identity column`
8. **TestPsqldefConfigIncludesSkipViews** - WARN logs in output (passes with `LOG_LEVEL=error`)

**Root cause**: pgquery doesn't support IDENTITY syntax, falls back to generic parser but generates incorrect ALTER statements

### GENERIC Parser Failures (4 tests fail as of latest run)
When running with `PSQLDEF_PARSER=generic`:

1. **TestApply/CreateViewWithCaseWhen** - View idempotency: parenthesization differences in complex expressions
2. **TestApply/LongAutoGeneratedForeignKeyConstraint** - Foreign key constraint name generation
3. **TestApply/ExcludeConstraintWithCreateTable** - Exclusion constraint handling
4. **TestApply/CreateTableWithConstraintOptions** - Constraint options (DEFERRABLE, etc.)

**Root causes of remaining failures**:
- View formatting differences between pg_get_viewdef() and parser output
- Foreign key and exclusion constraint edge cases
- Constraint options not properly compared

## Priority Issues to Fix

### High Priority - Generic Parser
1. **View idempotency** (PARTIALLY FIXED) - CASE WHEN views get dropped/recreated on each apply
   - String literal ::text casts now normalized âœ…
   - Remaining issue: Parenthesization and CAST vs :: syntax differences in complex expressions
   - Example: `to_timestamp(((expr))::bigint)` (from DB) vs `(to_timestamp(expr::bigint))` (from parser)
   - Root cause: pg_get_viewdef() returns different formatting than generic parser generates
   - Requires: Better AST normalization or accept functional equivalence
2. **Foreign key constraint name generation** - Auto-generated names for long foreign keys
3. **Exclusion constraint handling** - Exclusion constraint comparison issues
4. **Constraint options** - DEFERRABLE and INITIALLY DEFERRED options not properly compared

### High Priority - PGQUERY Parser
1. **IDENTITY column DDL generation** - Falls back to generic parser but generates incorrect ALTER statements (7 tests failing)
2. **Materialized view warnings** - Creates noise in test output (workaround: `LOG_LEVEL=error`)

### Medium Priority - Generic Parser
1. **CREATE EXTENSION** - Extension creation not supported (`CREATE EXTENSION citext;`)

