# TODO: Migration from pgquery to generic parser

This document tracks the failing tests when using `PSQLDEF_PARSER=generic`.

**Total failing tests: 121**

## Principle of Operation

* We are migrating from `pgquery` to `generic` parser, discarding `pgquery` in the future.
* However, `pgquery` will be kept for a while as a fallback parser.
* If something conflicts, the generic parser's way is correct. Update `pgquery` stuff to adjust to the generic parser's way.
* You can add test cases to debug, but do not modify the existing test cases.
* `parser/parser_test.go` is the test cases for the generic parser. Use it to develop the parser stuff.
* Keep the TODO list up-to-date.

## Summary by Issue Type

- **Unsupported SQL features**: 58 tests (CREATE SCHEMA, CREATE EXTENSION, GRANT, COMMENT)
- **Idempotence issues**: 39 tests (schema not applying correctly on re-run)
- **Migration output mismatch**: 23 tests (generated DDL doesn't match expected)
- **SQL syntax errors**: 5 tests (generated DDL has syntax errors)

## Priority Categories

### High Priority: SQL Syntax Errors (5 tests)
These generate invalid SQL that fails to execute:

- [ ] ConstraintCheckInAndUniqueAdd
  - Generated DDL: `ALTER TABLE ADD UNIQUE "level" ("level");` (invalid syntax)
  - Expected: `ALTER TABLE ADD CONSTRAINT "products_level_key" UNIQUE ("level");`

- [ ] ConstraintCheckInMultipleColumnsWithUnique
  - Generated DDL: `ALTER TABLE ADD UNIQUE "priority" ("priority", "category");` (invalid syntax)
  - Expected: `ALTER TABLE ADD CONSTRAINT "priority" UNIQUE ("priority", "category");`

- [ ] ConstraintUniqueAdd
  - Generated DDL has syntax errors with UNIQUE constraints

- [ ] CreateTableWithConstraintOptions
  - Generated DDL: `ADD UNIQUE "image_order_unique" (...) DEFERRABLE` (invalid syntax)
  - Expected: `ADD CONSTRAINT "image_order_unique" UNIQUE (...) DEFERRABLE`

- [ ] CreateViewCast
  - Generated DDL: `select amount collate  as amount_num` (invalid syntax)
  - Missing type cast in view definition

### High Priority: CHECK Constraint Issues (12 tests)
Issues with CHECK constraint parsing/generation, especially with ANY/ALL/SOME/IN operators:

- [ ] AllAnySomeCheckConstraintsCreate
  - Parser converts `ANY(ARRAY[...])` incorrectly

- [ ] AllAnySomeCheckConstraintsModifyAll
  - Current schema not idempotent
  - Generated: `CHECK (x in (...))` vs Expected: `CHECK (x = ANY(ARRAY[...]))`

- [ ] AllAnySomeCheckConstraintsModifySome
  - Current schema not idempotent
  - SOME operator not preserved correctly

- [ ] AllAnySomeCheckConstraintsRemove
  - Current schema not idempotent

- [ ] CheckConstraint
  - Migration output mismatch

- [ ] ConstraintCheckInAdd
  - Desired schema not idempotent

- [ ] ConstraintCheckInModify
  - Both current and desired schemas not idempotent
  - IN vs ANY conversion issue

- [ ] ConstraintCheckInRemove
  - Current schema not idempotent

- [ ] CreateTableWithCheckConstraints
  - Desired schema not idempotent

- [ ] LongAutoGeneratedCheckConstraint
  - Desired schema not idempotent
  - Auto-generated constraint names not matching

- [ ] ParseAllAnyCheckConstraint
  - Desired schema not idempotent

- [ ] SomeConstraintModificationsCreate
  - SOME operator not handled correctly

- [ ] SomeConstraintModificationsModify
  - Current and desired schemas not idempotent

- [ ] SomeConstraintModificationsSomeToAll
  - Current schema not idempotent

- [ ] SomeConstraintModificationsSomeToAny
  - Current schema not idempotent

### High Priority: EXCLUDE Constraint Issues (4 tests)
Issues with EXCLUDE constraint handling:

- [ ] ExcludeConstraintChange
  - Current schema not idempotent
  - Missing USING clause in generated DDL

- [ ] ExcludeConstraintDropAndAdd
  - Current schema not idempotent

- [ ] ExcludeConstraintWithAlterTable
  - Current schema not idempotent

- [ ] ExcludeConstraintWithCreateTable
  - Desired schema not idempotent
  - EXCLUDE constraints missing USING method

### Medium Priority: View-Related Issues (8 tests)
Views not being generated/compared correctly:

- [ ] CreateViewCast
  - View with CAST generates invalid SQL
  - Missing type cast syntax: `::numeric(10,2)`

- [ ] CreateViewWithCaseWhen
  - Desired schema not idempotent
  - CASE WHEN expressions not preserved

- [ ] CreateViewWithCastCase
  - Desired schema not idempotent

- [ ] NullCast
  - Desired schema not idempotent

- [ ] ReplaceViewWithChangeCondition
  - Desired schema not idempotent

- [ ] ViewDDLsAreEmittedLastWithChangingDefinition
  - Desired schema not idempotent

- [ ] ViewDDLsAreEmittedLastWithoutChangingDefinition
  - Desired schema not idempotent
  - CREATE OR REPLACE generated when not needed

- [ ] ViewWithGroupByAndHaving
  - Desired schema not idempotent

### Medium Priority: UNIQUE/FOREIGN KEY Constraint Issues (14 tests)
Issues with constraint handling:

- [ ] ConstraintCheckInAndUniqueAdd
  - Syntax error + migration mismatch

- [ ] ConstraintCheckInAndUniqueRemove
  - Current schema not idempotent

- [ ] ConstraintCheckInMultipleColumnsWithUnique
  - Syntax error + migration mismatch

- [ ] ConstraintCheckInWithUniqueCreate
  - Desired schema not idempotent

- [ ] ConstraintUniqueAdd
  - Syntax error + migration mismatch

- [ ] ConstraintUniqueRemove
  - Current schema not idempotent

- [ ] CreateTableAddAbsentForeignKey
  - Foreign key not being added (empty migration)

- [ ] ForeignKeyConstraintsAreEmittedLast
  - Migration output mismatch

- [ ] ForeignKeyDependenciesCascadeOptionsPreservation
  - Migration output mismatch

- [ ] ForeignKeyDependenciesCircular
  - Migration output mismatch
  - Type difference: `int` vs `integer`

- [ ] ForeignKeyDependenciesForCreateTables
  - Desired schema not idempotent

- [ ] ForeignKeyDependenciesMultipleToModifiedTable
  - Migration output mismatch

- [ ] ForeignKeyDependenciesPrimaryKeyChange
  - Both schemas not idempotent

- [ ] ForeignKeyOnReservedName
  - Migration output mismatch

### Low Priority: Unsupported SQL Features (58 tests)
These require parser extensions for CREATE SCHEMA, CREATE EXTENSION, GRANT, COMMENT:

#### CREATE SCHEMA (35 tests)
- [ ] AddBooleanColumnOnNonStandardDefaultSchema
- [ ] AddBooleanColumnWithExplicitSchema
- [ ] AddByteaColumnOnNonStandardDefaultSchema
- [ ] AddDoublePrecisionColumnOnNonStandardDefaultSchema
- [ ] AddEnumTypeColumn
- [ ] AddEnumTypeColumnOnNonStandardDefaultSchema
- [ ] AddEnumTypeColumnWithExplicitSchemaOnNonStandardDefaultSchema
- [ ] AddIntegerColumnOnNonStandardDefaultSchema
- [ ] AddJSONBColumnOnNonStandardDefaultSchema
- [ ] AddNumericColumnOnNonStandardDefaultSchema
- [ ] AddRealColumnOnNonStandardDefaultSchema
- [ ] AddTextColumnOnNonStandardDefaultSchema
- [ ] AddTimestampColumnOnNonStandardDefaultSchema
- [ ] AddTimestamptzColumnOnNonStandardDefaultSchema
- [ ] AddTimetzColumnOnNonStandardDefaultSchema
- [ ] AddUUIDColumnOnNonStandardDefaultSchema
- [ ] AddVarcharColumnOnNonStandardDefaultSchema
- [ ] AlterTypeAddValueWithSameTypeNameInDifferentSchema
- [ ] CommentOnNonStandardDefaultSchema
- [ ] CommentWithoutSchema
- [ ] CreateSchema
- [ ] CreateTableOnNonStandardDefaultSchema
- [ ] DropTableOnNonStandardDefaultSchema
- [ ] RenameIndexInNonDefaultSchema

#### CREATE EXTENSION (7 tests)
- [ ] AddColumnWithDefaultExpression
- [ ] AddDefaultExpression
- [ ] CreateExtension
- [ ] CreateExtensionIfNotExists
- [ ] CreateExtensionOrder
- [ ] DropExtension
- [ ] RemoveDefaultExpression
- [ ] RenameColumnQuotedDoubleQuotes

#### COMMENT (6 tests)
- [ ] Comment
- [ ] CommentContainingQuote
- [ ] CommentWithoutSchemaWithTableNameQuoted
- [ ] CommentWithoutSchemaWithoutTableNameQuoted
- [ ] MultipleComments
- [ ] UpdateComment

#### GRANT/REVOKE (20 tests)
- [ ] ManagedRolesAddPrivileges
- [ ] ManagedRolesAllPrivileges
- [ ] ManagedRolesBasicGrant
- [ ] ManagedRolesEmptyListNoChanges
- [ ] ManagedRolesErrorCascade
- [ ] ManagedRolesErrorGrantOption
- [ ] ManagedRolesIdempotent
- [ ] ManagedRolesIgnoreUnmanagedRole
- [ ] ManagedRolesMixedGrantRevoke
- [ ] ManagedRolesMultipleGrantees
- [ ] ManagedRolesMultipleRoles
- [ ] ManagedRolesMultipleTables
- [ ] ManagedRolesNoRevokeWithoutDrop
- [ ] ManagedRolesOverlapping
- [ ] ManagedRolesPartialGrantees
- [ ] ManagedRolesPartialRevokeFromAll
- [ ] ManagedRolesPublic
- [ ] ManagedRolesRevoke
- [ ] ManagedRolesRevokeAll
- [ ] ManagedRolesSpecialCharacters

### Low Priority: Other TestApply Failures (9 tests)

- [ ] ChangeDefaultExpressionWithAddition
  - Migration output mismatch

- [ ] ChangeTimezoneSyntax
  - Both schemas not idempotent
  - Timezone syntax not preserved

- [ ] CreateIndexWithBoolExpr
  - Desired schema not idempotent

- [ ] IndexesOnChangedExpressions
  - Migration output mismatch

### Non-TestApply Test Failures (16 tests)

- [ ] TestPsqldefAddUniqueConstraintToTableInNonpublicSchema
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefCheckConstraintInSchema
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefCitextExtension
  - Issue: CREATE EXTENSION syntax error

- [ ] TestPsqldefConfigIncludesTargetSchema
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefConfigIncludesTargetSchemaWithViews
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefCreateIndex
  - Subtests:
    - [ ] in_public_schema
    - [ ] in_non-public_schema

- [ ] TestPsqldefCreateMaterializedView
  - Subtests:
    - [ ] in_public_schema
    - [ ] in_non-public_schema

- [ ] TestPsqldefCreateMaterializedViewIndex

- [ ] TestPsqldefCreateTableInSchema
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefCreateTableWithConstraintReferences
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefCreateType

- [ ] TestPsqldefCreateView
  - Subtests:
    - [ ] in_public_schema
    - [ ] in_non-public_schema

- [ ] TestPsqldefFunctionAsDefault
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefIgnoreExtension
  - Issue: CREATE EXTENSION not supported

- [ ] TestPsqldefSameTableNameAmongSchemas
  - Issue: CREATE SCHEMA not supported

- [ ] TestPsqldefTableLevelCheckConstraintsWithAllAny
  - Issue: ANY/ALL/IN CHECK constraint handling

## Implementation Plan

### Phase 1: Critical Fixes (SQL Syntax Errors)
1. Fix UNIQUE constraint syntax to include CONSTRAINT keyword
2. Fix view CAST expression generation
3. Fix DEFERRABLE constraint syntax

### Phase 2: CHECK Constraint Support
1. Add support for ANY/ALL/SOME operators in CHECK constraints
2. Fix IN operator conversion (should preserve as-is, not convert to ANY)
3. Fix auto-generated constraint name matching

### Phase 3: EXCLUDE Constraint Support
1. Add EXCLUDE constraint parsing
2. Ensure USING clause is preserved
3. Fix idempotence checks for EXCLUDE constraints

### Phase 4: View Improvements
1. Fix CAST expression preservation in views
2. Fix CASE WHEN expression handling
3. Improve view comparison for idempotence

### Phase 5: Foreign Key & UNIQUE Constraints
1. Fix foreign key detection and addition
2. Fix type normalization (int vs integer)
3. Improve constraint dependency ordering

### Phase 6: Extended SQL Support (Optional)
1. Add CREATE SCHEMA support
2. Add CREATE EXTENSION support
3. Add COMMENT support
4. Add GRANT/REVOKE support
