# yaml-language-server: $schema=../../testutil/testcase.schema.json

# MariaDB Vector Index Tests
CreateVectorIndex:
  desired: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(3) NOT NULL,
      PRIMARY KEY (id)
    );
    CREATE VECTOR INDEX idx_vector ON vectors (vector_col);
  up: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(3) NOT NULL,
      PRIMARY KEY (id)
    );
    CREATE VECTOR INDEX idx_vector ON vectors (vector_col);
  down: |
    DROP TABLE `vectors`;
  flavor: mariadb
CreateVectorIndexWithOptions:
  desired: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(512) NOT NULL,
      PRIMARY KEY (id)
    );
    CREATE VECTOR INDEX idx_vector_cosine ON vectors (vector_col) DISTANCE=COSINE M=16;
  up: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(512) NOT NULL,
      PRIMARY KEY (id)
    );
    CREATE VECTOR INDEX idx_vector_cosine ON vectors (vector_col) DISTANCE=COSINE M=16;
  down: |
    DROP TABLE `vectors`;
  flavor: mariadb
AddVectorIndex:
  current: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(512) NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(512) NOT NULL,
      PRIMARY KEY (id),
      VECTOR INDEX idx_vector (vector_col)
    );
  up: |
    ALTER TABLE `vectors` ADD VECTOR INDEX `idx_vector` (`vector_col`);
  down: |
    ALTER TABLE `vectors` DROP INDEX `idx_vector`;
  flavor: mariadb
DropVectorIndex:
  current: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(512) NOT NULL,
      PRIMARY KEY (id),
      VECTOR INDEX idx_vector (vector_col)
    );
  desired: |
    CREATE TABLE vectors (
      id int(10) unsigned NOT NULL AUTO_INCREMENT,
      vector_col VECTOR(512) NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `vectors` DROP INDEX `idx_vector`;
  down: |
    ALTER TABLE `vectors` ADD VECTOR INDEX `idx_vector` (`vector_col`);
  flavor: mariadb

# MariaDB-Compatible Alternatives to MySQL-only Tests

# MariaDB doesn't support JSON_ARRAY() default expressions like MySQL 8.0
AddColumnWithDefaultExpressionMariaDB:
  current: |
    CREATE TABLE users (id BIGINT PRIMARY KEY);
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT '[]' CHECK (json_valid(data))
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT '[]' CHECK (json_valid(data)) AFTER `id`;
  down: |
    ALTER TABLE `users` DROP COLUMN `data`;
  flavor: mariadb

AddDefaultExpressionMariaDB:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin CHECK (json_valid(data))
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT '[]' CHECK (json_valid(data))
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `data` `data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT '[]' CHECK (json_valid(data));
  down: |
    ALTER TABLE `users` CHANGE COLUMN `data` `data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin CHECK (json_valid(data));
  flavor: mariadb

RemoveDefaultExpressionMariaDB:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT '[]' CHECK (json_valid(data))
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin CHECK (json_valid(data))
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `data` `data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin CHECK (json_valid(data));
  down: |
    ALTER TABLE `users` CHANGE COLUMN `data` `data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT '[]' CHECK (json_valid(data));
  flavor: mariadb

# MariaDB AUTO_INCREMENT handling (compatible with older MySQL behavior)
# Note: min_version: '10.0' ensures these only run on MariaDB (10.x+), not MySQL (5.7/8.x)
CreateTableAddAutoIncrementMariaDB:
  current: |
    CREATE TABLE users (
      id bigint(20) NOT NULL PRIMARY KEY,
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(20)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint(20) NOT NULL AUTO_INCREMENT;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint(20) NOT NULL;
  flavor: mariadb
  min_version: '10.0'

CreateTableAddAutoIncrementPrimaryKeyMariaDB:
  current: |
    CREATE TABLE users (
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL AUTO_INCREMENT,
      name varchar(20),
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `id` bigint NOT NULL FIRST;
    ALTER TABLE `users` ADD PRIMARY KEY (`id`);
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint NOT NULL AUTO_INCREMENT;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint(20) NOT NULL;
    ALTER TABLE `users` DROP PRIMARY KEY;
    ALTER TABLE `users` DROP COLUMN `id`;
  flavor: mariadb
  min_version: '10.0'

CreateTableRemoveAutoIncrementMariaDB:
  current: |
    CREATE TABLE users (
      id bigint(20) NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) NOT NULL PRIMARY KEY,
      name varchar(20)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint(20) NOT NULL;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint(20) NOT NULL AUTO_INCREMENT;
  flavor: mariadb
  min_version: '10.0'

CreateTableRemoveAutoIncrementPrimaryKeyMariaDB:
  current: |
    CREATE TABLE friends (
      id bigint(20) NOT NULL AUTO_INCREMENT PRIMARY KEY,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE friends (
      created_at datetime NOT NULL
    );
  up: |
    ALTER TABLE `friends` CHANGE COLUMN `id` `id` bigint(20) NOT NULL;
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` DROP COLUMN `id`;
  down: |
    ALTER TABLE `friends` ADD COLUMN `id` bigint(20) NOT NULL FIRST;
    ALTER TABLE `friends` ADD PRIMARY KEY (`id`);
    ALTER TABLE `friends` CHANGE COLUMN `id` `id` bigint(20) NOT NULL AUTO_INCREMENT;
  flavor: mariadb
  min_version: '10.0'

CreateTableWithAutoIncrementPrimaryKeyAndAddMorePrimaryKeyMariaDB:
  current: |
    CREATE TABLE friends (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      other_id bigint(20) NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (`id`)
    );
  desired: |
    CREATE TABLE friends (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      other_id bigint(20) NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (`id`, `other_id`)
    );
  up: |
    ALTER TABLE `friends` CHANGE COLUMN `id` `id` bigint(20) NOT NULL;
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` ADD PRIMARY KEY (`id`, `other_id`);
    ALTER TABLE `friends` CHANGE COLUMN `id` `id` bigint(20) NOT NULL AUTO_INCREMENT;
  down: |
    ALTER TABLE `friends` CHANGE COLUMN `id` `id` bigint(20) NOT NULL;
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` ADD PRIMARY KEY (`id`);
    ALTER TABLE `friends` CHANGE COLUMN `id` `id` bigint(20) NOT NULL AUTO_INCREMENT;
  flavor: mariadb
  min_version: '10.0'
