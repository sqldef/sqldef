# yaml-language-server: $schema=../../testutil/testcase.schema.json

CreateTableGeneratedAlwaysAs80:
  desired: |
    CREATE TABLE `test_table` (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      PRIMARY KEY (id)
    );
  min_version: '8.0'
CreateTableGeneratedAlwaysAsChangeExpr80:
  flavor: "!mariadb"
  current: |
    CREATE TABLE `test_table` (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE `test_table` (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) VIRTUAL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) VIRTUAL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL;
  min_version: '8.0'
CreateTableGeneratedAlwaysAsAbbreviation80:
  flavor: "!mariadb"
  desired: |
    CREATE TABLE `test_table` (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) AS ('test') STORED NOT NULL,
      test_expr varchar(45) AS (test_value / test_value) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  min_version: '8.0'
CreateTableGeneratedAlwaysAsAbbreviationChangeExpr80:
  flavor: mysql
  current: |
    CREATE TABLE `test_table` (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') STORED NOT NULL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE `test_table` (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) AS ('test') STORED NOT NULL,
      test_expr varchar(45) AS ((test_value / test_value) * 2) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED NOT NULL;
  min_version: '8.0'
ChangeGenerateColumnGemerayedAlwaysAs:
  flavor: "!mariadb"
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name1')) VIRTUAL,
      PRIMARY KEY (id)
    );
ChangeGenerateColumnJsonExpressionChange:
  flavor: "!mariadb"
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name1')) VIRTUAL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) VIRTUAL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) VIRTUAL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name1')) VIRTUAL;
ChangeGenerateColumnVirtualToStored:
  flavor: mysql
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) VIRTUAL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` DROP COLUMN `test_expr`;
    ALTER TABLE `test_table` ADD COLUMN `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED AFTER `test_value`;
    ALTER TABLE `test_table` DROP COLUMN `name`;
    ALTER TABLE `test_table` ADD COLUMN `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED AFTER `data`;
  down: |
    ALTER TABLE `test_table` DROP COLUMN `test_expr`;
    ALTER TABLE `test_table` ADD COLUMN `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL AFTER `test_value`;
    ALTER TABLE `test_table` DROP COLUMN `name`;
    ALTER TABLE `test_table` ADD COLUMN `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) VIRTUAL AFTER `data`;
ChangeGenerateColumnStoredToVirtual:
  flavor: mysql
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) VIRTUAL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` DROP COLUMN `test_expr`;
    ALTER TABLE `test_table` ADD COLUMN `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL AFTER `test_value`;
    ALTER TABLE `test_table` DROP COLUMN `name`;
    ALTER TABLE `test_table` ADD COLUMN `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) VIRTUAL AFTER `data`;
  down: |
    ALTER TABLE `test_table` DROP COLUMN `test_expr`;
    ALTER TABLE `test_table` ADD COLUMN `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED AFTER `test_value`;
    ALTER TABLE `test_table` DROP COLUMN `name`;
    ALTER TABLE `test_table` ADD COLUMN `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED AFTER `data`;
ChangeGenerateColumnSpacingIgnored:
  flavor: "!mariadb"
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ( test_value / test_value ) STORED,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED,
      PRIMARY KEY (id)
    );
  up: ""
  down: ""
ChangeGenerateColumnAddNotNull:
  flavor: "!mariadb"
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ( test_value / test_value ) STORED,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED NOT NULL;
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED NOT NULL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED;
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED;
ChangeGenerateColumnExpressionComplexity:
  flavor: mysql
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `test_expr` `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED NOT NULL;
ChangeGenerateColumnSubstrFunction:
  flavor: mysql
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (substr('test_value', 1, 2)) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (substr('test_value', 1, 2)) STORED NOT NULL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED NOT NULL;
ChangeGenerateColumnSubstringFunction:
  flavor: mysql
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (substr('test_value', 1, 2)) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS ((test_value / test_value) * 2) STORED NOT NULL,
      data json NOT NULL,
      name varchar(20) GENERATED ALWAYS AS (substring('test_value', 2, 2)) STORED NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (substr('test_value', 2, 2)) STORED NOT NULL;
  down: |
    ALTER TABLE `test_table` CHANGE COLUMN `name` `name` varchar(20) GENERATED ALWAYS AS (substr('test_value', 1, 2)) STORED NOT NULL;
ChangeGenerateColumnRegularToGenerated:
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      name varchar(50) NOT NULL,
      base_value int(11) NOT NULL,
      computed_value int(11),
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      name varchar(50) NOT NULL,
      base_value int(11) NOT NULL,
      computed_value int(11) GENERATED ALWAYS AS (base_value * 2) VIRTUAL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` DROP COLUMN `computed_value`;
    ALTER TABLE `test_table` ADD COLUMN `computed_value` int(11) GENERATED ALWAYS AS (base_value * 2) VIRTUAL AFTER `base_value`;
  down: |
    ALTER TABLE `test_table` DROP COLUMN `computed_value`;
    ALTER TABLE `test_table` ADD COLUMN `computed_value` int(11) AFTER `base_value`;
ChangeGenerateColumnGeneratedToRegular:
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      name varchar(50) NOT NULL,
      base_value int(11) NOT NULL,
      computed_value int(11) GENERATED ALWAYS AS (base_value * 2) VIRTUAL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      name varchar(50) NOT NULL,
      base_value int(11) NOT NULL,
      computed_value int(11),
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` DROP COLUMN `computed_value`;
    ALTER TABLE `test_table` ADD COLUMN `computed_value` int(11) AFTER `base_value`;
  down: |
    ALTER TABLE `test_table` DROP COLUMN `computed_value`;
    ALTER TABLE `test_table` ADD COLUMN `computed_value` int(11) GENERATED ALWAYS AS (base_value * 2) VIRTUAL AFTER `base_value`;

# Change generated column from VIRTUAL to STORED with CHECK constraint (works on MySQL and MariaDB, not on TiDB)
ChangeGenerateColumnVirtualToStoredWithCheck:
  flavor: "!tidb"
  current: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL CHECK (json_valid(data)),
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) VIRTUAL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE test_table (
      id int(11) NOT NULL AUTO_INCREMENT,
      test_value varchar(45) GENERATED ALWAYS AS ('test') VIRTUAL,
      test_expr varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED,
      data LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL CHECK (json_valid(data)),
      name varchar(20) GENERATED ALWAYS AS (json_extract(data,'$.name2')) STORED,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `test_table` DROP COLUMN `test_expr`;
    ALTER TABLE `test_table` ADD COLUMN `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) STORED AFTER `test_value`;
    ALTER TABLE `test_table` DROP COLUMN `name`;
    ALTER TABLE `test_table` ADD COLUMN `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) STORED AFTER `data`;
  down: |
    ALTER TABLE `test_table` DROP COLUMN `test_expr`;
    ALTER TABLE `test_table` ADD COLUMN `test_expr` varchar(45) GENERATED ALWAYS AS (test_value / test_value) VIRTUAL AFTER `test_value`;
    ALTER TABLE `test_table` DROP COLUMN `name`;
    ALTER TABLE `test_table` ADD COLUMN `name` varchar(20) GENERATED ALWAYS AS (json_extract(data, '$.name2')) VIRTUAL AFTER `data`;
