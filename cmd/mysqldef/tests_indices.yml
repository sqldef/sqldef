# yaml-language-server: $schema=../../testutil/testcase.schema.json

CreateTableUniqueIndex:
  desired: |
    CREATE TABLE items (
      id int NOT NULL,
      created DATE NOT NULL,
      UNIQUE INDEX(id, created)
    );
CreateTableAddIndexWithKeyLength:
  current: |
    CREATE TABLE users (
      id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
      name TEXT NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
      name TEXT NOT NULL,
      PRIMARY KEY (id),
      INDEX index_name(name(255))
    );
  up: |
    ALTER TABLE `users` ADD INDEX `index_name` (`name`(255));
  down: |
    ALTER TABLE `users` DROP INDEX `index_name`;
AddIndex:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    ALTER TABLE `users` ADD UNIQUE INDEX `index_name`(`name`);
  up: |
    ALTER TABLE `users` ADD UNIQUE INDEX `index_name`(`name`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_name`;
ChangeIndexColumns:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    ALTER TABLE `users` ADD UNIQUE INDEX `index_name`(`name`);
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    ALTER TABLE `users` ADD INDEX `index_name`(`name`, `created_at`);
  up: |
    ALTER TABLE `users` DROP INDEX `index_name`;
    ALTER TABLE `users` ADD INDEX `index_name`(`name`, `created_at`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_name`;
    ALTER TABLE `users` ADD UNIQUE INDEX `index_name`(`name`);
AddIndexWithKeyLength:
  current: |
    CREATE TABLE users (
      id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
      name TEXT NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
      name TEXT NOT NULL,
      PRIMARY KEY (id)
    );
    ALTER TABLE `users` ADD INDEX `index_name`(`name`(255));
  up: |
    ALTER TABLE `users` ADD INDEX `index_name`(`name`(255));
  down: |
    ALTER TABLE `users` DROP INDEX `index_name`;
IndexOption:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id) USING BTREE
    );
  up: |
    ALTER TABLE `users` ADD KEY `index_id` (`id`) using BTREE;
  down: |
    ALTER TABLE `users` DROP INDEX `index_id`;
IndexOptionCaseInsensitive:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id) USING BTREE
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id) using btree
    );
IndexOptionNoUsing:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id) USING BTREE
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id)
    );
IndexOptionAddWithoutUsing:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id)
    );
  up: |
    ALTER TABLE `users` ADD KEY `index_id` (`id`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_id`;
IndexOptionAddWithoutUsingThenWith:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id)
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      KEY index_id (id) USING BTREE
    );
MultipleColumnIndexesOption:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type) USING BTREE
    );
  up: |
    ALTER TABLE `users` ADD INDEX `index_id` (`registered_at`, `role_type`) using BTREE;
  down: |
    ALTER TABLE `users` DROP INDEX `index_id`;
MultipleColumnIndexesOptionCaseInsensitive:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type) USING BTREE
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type) using btree
    );
MultipleColumnIndexesOptionNoUsing:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type) USING BTREE
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type)
    );
MultipleColumnIndexesOptionAddWithoutUsing:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type)
    );
  up: |
    ALTER TABLE `users` ADD INDEX `index_id` (`registered_at`, `role_type`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_id`;
MultipleColumnIndexesOptionAddWithoutUsingThenWith:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type)
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type) USING BTREE
    );
MultipleColumnIndexesOptionAddWithoutUsingThenCaseInsensitive:
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type)
    );
  desired: |
    CREATE TABLE users (
      id int(11) NOT NULL,
      registered_at datetime(6) NOT NULL,
      role_type int(1) NOT NULL,
      INDEX index_id (registered_at, role_type) using btree
    );
FulltextIndex:
  desired: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title) /*!50100 WITH PARSER ngram */
    );
  up: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title) /*!50100 WITH PARSER ngram */
    );
  down: |
    DROP TABLE `posts`;
  flavor: mysql  # MariaDB doesn't support ngram parser
FulltextIndexDrop:
  current: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title) /*!50100 WITH PARSER ngram */
    );
  desired: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL
    );
  up: |
    ALTER TABLE `posts` DROP INDEX `title_fulltext_index`;
  down: |
    ALTER TABLE `posts` ADD FULLTEXT KEY `title_fulltext_index` (`title`) WITH parser ngram;
  flavor: mysql  # MariaDB doesn't support ngram parser
FulltextIndexReAdd:
  current: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL
    );
  desired: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title) /*!50100 WITH PARSER ngram */
    );
  up: |
    ALTER TABLE `posts` ADD FULLTEXT KEY `title_fulltext_index` (`title`) WITH parser ngram;
  down: |
    ALTER TABLE `posts` DROP INDEX `title_fulltext_index`;
  flavor: mysql  # MariaDB doesn't support ngram parser
CreateIndex:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    CREATE INDEX index_name ON users (name);
    CREATE UNIQUE INDEX index_created_at ON users (created_at);
  up: |
    CREATE INDEX index_name ON users (name);
    CREATE UNIQUE INDEX index_created_at ON users (created_at);
  down: |
    ALTER TABLE `users` DROP INDEX `index_created_at`;
    ALTER TABLE `users` DROP INDEX `index_name`;
CreateIndexDrop:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    CREATE INDEX index_name ON users (name);
    CREATE UNIQUE INDEX index_created_at ON users (created_at);
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  up: |
    ALTER TABLE `users` DROP INDEX `index_created_at`;
    ALTER TABLE `users` DROP INDEX `index_name`;
  down: |
    CREATE INDEX index_name ON users (name);
    CREATE UNIQUE INDEX index_created_at ON users (created_at);
CreateTableKey:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL,
      KEY index_name(name),
      UNIQUE KEY index_created_at(created_at)
    );
  up: |
    ALTER TABLE `users` ADD KEY `index_name` (`name`);
    ALTER TABLE `users` ADD UNIQUE KEY `index_created_at` (`created_at`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_created_at`;
    ALTER TABLE `users` DROP INDEX `index_name`;
CreateTableWithUniqueColumnDrop:
  flavor: "!tidb"  # TiDB does not support ADD COLUMN with UNIQUE constraint
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name varchar(40) UNIQUE
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY
    );
  up: |
    ALTER TABLE `users` DROP INDEX `name`;
    ALTER TABLE `users` DROP COLUMN `name`;
  down: |
    ALTER TABLE `users` ADD COLUMN `name` varchar(40) UNIQUE AFTER `id`;
CreateTableWithUniqueColumn:
  flavor: "!tidb"  # TiDB does not support ADD COLUMN with UNIQUE constraint
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name varchar(40) UNIQUE
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `name` varchar(40) UNIQUE AFTER `id`;
  down: |
    ALTER TABLE `users` DROP INDEX `name`;
    ALTER TABLE `users` DROP COLUMN `name`;
CreateTableChangeUniqueColumn:
  current: |
    CREATE TABLE users (
      name varchar(40)
    );
  desired: |
    CREATE TABLE users (
      name varchar(40) UNIQUE
    );
  up: |
    ALTER TABLE `users` ADD UNIQUE KEY `name`(`name`);
  down: |
    ALTER TABLE `users` DROP INDEX `name`;
IndexWithDot:
  current: |
    CREATE TABLE users (
      `id` BIGINT,
      `account_id` BIGINT
    );
  desired: |
    CREATE TABLE users (
      `id` BIGINT,
      `account_id` BIGINT,
      KEY `account.id`(account_id)
    );
  up: |
    ALTER TABLE `users` ADD KEY `account.id` (`account_id`);
  down: |
    ALTER TABLE `users` DROP INDEX `account.id`;
ChangeIndexCombination:
  current: |
    CREATE TABLE users (
      `id` BIGINT,
      `name` varchar(255),
      `account_id` BIGINT,
      KEY `index_users1`(account_id),
      KEY `index_users2`(account_id, name)
    );
  desired: |
    CREATE TABLE users (
      `id` BIGINT,
      `name` varchar(255),
      `account_id` BIGINT,
      KEY `index_users1`(account_id, name),
      KEY `index_users2`(account_id)
    );
  up: |
    ALTER TABLE `users` DROP INDEX `index_users1`;
    ALTER TABLE `users` ADD KEY `index_users1` (`account_id`, `name`);
    ALTER TABLE `users` DROP INDEX `index_users2`;
    ALTER TABLE `users` ADD KEY `index_users2` (`account_id`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_users1`;
    ALTER TABLE `users` ADD KEY `index_users1` (`account_id`);
    ALTER TABLE `users` DROP INDEX `index_users2`;
    ALTER TABLE `users` ADD KEY `index_users2` (`account_id`, `name`);

# Basic fulltext indexes (works on both MySQL and MariaDB, without ngram parser)
FulltextIndexBasic:
  desired: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title)
    );
  up: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title)
    );
  down: |
    DROP TABLE `posts`;

FulltextIndexDropBasic:
  current: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title)
    );
  desired: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL
    );
  up: |
    ALTER TABLE `posts` DROP INDEX `title_fulltext_index`;
  down: |
    ALTER TABLE `posts` ADD FULLTEXT KEY `title_fulltext_index` (`title`);

FulltextIndexReAddBasic:
  current: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL
    );
  desired: |
    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title varchar(40) DEFAULT NULL,
      FULLTEXT KEY title_fulltext_index (title)
    );
  up: |
    ALTER TABLE `posts` ADD FULLTEXT KEY `title_fulltext_index` (`title`);
  down: |
    ALTER TABLE `posts` DROP INDEX `title_fulltext_index`;
