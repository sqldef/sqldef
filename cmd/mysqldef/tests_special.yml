# yaml-language-server: $schema=../../testutil/testcase.schema.json

MysqlComment:
  desired: |
    CREATE TABLE users(
      id bigint NOT NULL /* comment */
    );
SubstrExpression:
  desired: |
    CREATE VIEW modelstart_end AS select substr(min(202006),1,4) AS `c`;
    CREATE VIEW modelstart_end2 AS select substr(min(202006),1) AS `c`;
    CREATE VIEW modelstart_end3 AS select substr(min(202006) from 1) AS `c`;
    CREATE VIEW modelstart_end4 AS select substr(min(202006) from 1 for 4) AS `c`;
SubstringExpression:
  desired: |
    CREATE VIEW modelstart_end11 AS select substring(min(202006),1,4) AS `c`;
    CREATE VIEW modelstart_end12 AS select substring(min(202006),1) AS `c`;
    CREATE VIEW modelstart_end13 AS select substring(min(202006) from 1) AS `c`;
    CREATE VIEW modelstart_end14 AS select substring(min(202006) from 1 for 4) AS `c`;
NonReservedColumnName:
  # TODO: broken. they could be non-reserved once we split parsers for each database
  desired: |
    CREATE TABLE `global` (
      `money` INT,
      `language` TEXT,
      `json` TEXT
    );
PartitionByRange:
  desired: |
    CREATE TABLE `users` (
      `uuid` varchar(37) NOT NULL,
      `name` varchar(255) DEFAULT NULL,
      `joined` date NOT NULL,
      PRIMARY KEY (`uuid`,`joined`)
    ) ENGINE=InnoDB DEFAULT CHARSET=latin1
    /*!50100 PARTITION BY RANGE (year(`joined`))
    (PARTITION p202109 VALUES LESS THAN ('2021-10-01'),
     PARTITION p202110 VALUES LESS THAN ('2021-11-01'),
     PARTITION p202111 VALUES LESS THAN ('2021-12-01'),
     PARTITION p202112 VALUES LESS THAN ('2022-01-01'),
     PARTITION pmax VALUES LESS THAN MAXVALUE) */;
  up: |
    CREATE TABLE `users` (
      `uuid` varchar(37) NOT NULL,
      `name` varchar(255) DEFAULT NULL,
      `joined` date NOT NULL,
      PRIMARY KEY (`uuid`,`joined`)
    ) ENGINE=InnoDB DEFAULT CHARSET=latin1;
  down: |
    DROP TABLE `users`;

# https://github.com/sqldef/sqldef/discussions/635
PartitionByRangeWithToDays:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE api_log (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      biz_no varchar(60) DEFAULT NULL,
      host_app varchar(255) DEFAULT NULL,
      host_ip varchar(255) DEFAULT NULL,
      target_app varchar(255) DEFAULT NULL,
      uri varchar(255) DEFAULT NULL,
      request_time datetime DEFAULT NULL,
      response_time datetime DEFAULT NULL,
      date_created datetime NOT NULL,
      PRIMARY KEY (id, date_created)
    )
    PARTITION BY RANGE (TO_DAYS(date_created))
    (PARTITION p20240624 VALUES LESS THAN (739400),
     PARTITION p20240625 VALUES LESS THAN (739401),
     PARTITION p20240626 VALUES LESS THAN (739402),
     PARTITION p20240627 VALUES LESS THAN (739403),
     PARTITION p20240628 VALUES LESS THAN (739404),
     PARTITION p20240629 VALUES LESS THAN (739405));

PartitionByRangeColumns:
  legacy_ignore_quotes: false
  flavor: "!tidb"  # TiDB has limited support for RANGE COLUMNS
  desired: |
    CREATE TABLE orders (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      order_date date NOT NULL,
      region varchar(20) NOT NULL,
      amount decimal(10,2) DEFAULT NULL,
      PRIMARY KEY (id, order_date, region)
    )
    PARTITION BY RANGE COLUMNS (order_date)
    (PARTITION p_2024_q1 VALUES LESS THAN ('2024-04-01'),
     PARTITION p_2024_q2 VALUES LESS THAN ('2024-07-01'),
     PARTITION p_2024_q3 VALUES LESS THAN ('2024-10-01'),
     PARTITION p_2024_q4 VALUES LESS THAN ('2025-01-01'),
     PARTITION p_max VALUES LESS THAN (MAXVALUE));

PartitionByHash:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE sessions (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      user_id bigint(20) NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (id, user_id)
    )
    PARTITION BY HASH (user_id);

PartitionByHashWithPartitions:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE cache_data (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      cache_key varchar(255) NOT NULL,
      cache_value text,
      PRIMARY KEY (id, cache_key)
    )
    PARTITION BY HASH (id)
    PARTITIONS 4;

PartitionByLinearHash:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE events (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      event_type int NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (id, event_type)
    )
    PARTITION BY LINEAR HASH (event_type);

PartitionByKey:
  legacy_ignore_quotes: false
  flavor: "!tidb"  # TiDB has limited support for KEY partitioning
  desired: |
    CREATE TABLE messages (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      sender_id bigint(20) NOT NULL,
      receiver_id bigint(20) NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (id, sender_id, receiver_id)
    )
    PARTITION BY KEY (sender_id, receiver_id);

PartitionByLinearKey:
  legacy_ignore_quotes: false
  flavor: "!tidb"  # TiDB has limited support for KEY partitioning
  desired: |
    CREATE TABLE logs (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      log_date date NOT NULL,
      log_level int NOT NULL,
      PRIMARY KEY (id, log_date)
    )
    PARTITION BY LINEAR KEY (log_date);

PartitionByList:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE regional_sales (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      region_code int NOT NULL,
      amount decimal(10,2) DEFAULT NULL,
      PRIMARY KEY (id, region_code)
    )
    PARTITION BY LIST (region_code)
    (PARTITION p_north VALUES IN (1, 2, 3),
     PARTITION p_south VALUES IN (4, 5, 6),
     PARTITION p_east VALUES IN (7, 8, 9),
     PARTITION p_west VALUES IN (10, 11, 12));

PartitionByListColumns:
  legacy_ignore_quotes: false
  flavor: "!tidb"  # TiDB has limited support for LIST COLUMNS
  desired: |
    CREATE TABLE country_sales (
      id bigint(20) NOT NULL AUTO_INCREMENT,
      country varchar(10) NOT NULL,
      amount decimal(10,2) DEFAULT NULL,
      PRIMARY KEY (id, country)
    )
    PARTITION BY LIST COLUMNS (country)
    (PARTITION p_americas VALUES IN ('US', 'CA', 'MX'),
     PARTITION p_europe VALUES IN ('UK', 'DE', 'FR'),
     PARTITION p_asia VALUES IN ('JP', 'CN', 'KR'));

CreateTableWithSpatialTypesAndSpatialKey:
  flavor: "!tidb"  # TiDB has limited support for spatial types
  current: |
    CREATE TABLE users (
      id bigint(20) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) NOT NULL,
      location point NOT NULL,
      SPATIAL KEY index_users_location (location)
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `location` point NOT NULL AFTER `id`;
    ALTER TABLE `users` ADD SPATIAL KEY `index_users_location` (`location`);
  down: |
    ALTER TABLE `users` DROP INDEX `index_users_location`;
    ALTER TABLE `users` DROP COLUMN `location`;
CreateTableWithSpatialTypesSRIDSpecified:
  flavor: "!tidb"  # TiDB has limited support for spatial types
  current: |
    CREATE TABLE users (
      id bigint(20) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) NOT NULL,
      location point NOT NULL /*!80003 SRID 4326 */
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `location` point NOT NULL /*!80003 SRID 4326 */ AFTER `id`;
  down: |
    ALTER TABLE `users` DROP COLUMN `location`;
ColumnLiteral:
  desired: |
    CREATE TABLE users (
      `id` bigint NOT NULL,
      `name` text
      );
HyphenNames:
  desired: |
    CREATE TABLE `foo-bar_baz` (
      `id-bar_baz` bigint NOT NULL
    );
KeywordIndexColumns:
  flavor: "!tidb"  # TiDB has collation handling differences
  desired: |
    CREATE TABLE tools (
      `character` varchar(255) COLLATE utf8mb4_bin DEFAULT NULL
    );
KeywordIndexColumnsAddIndex:
  flavor: "!tidb"  # TiDB has collation handling differences
  current: |
    CREATE TABLE tools (
      `character` varchar(255) COLLATE utf8mb4_bin DEFAULT NULL
    );
  desired: |
    CREATE TABLE tools (
      `character` varchar(255) COLLATE utf8mb4_bin DEFAULT NULL,
      KEY `index_character`(`character`)
    );
  up: |
    ALTER TABLE `tools` ADD KEY `index_character` (`character`);
  down: |
    ALTER TABLE `tools` DROP INDEX `index_character`;
MysqlDoubleDashComment:
  desired: |
    -- comment 1
    CREATE TABLE users(
      id bigint NOT NULL
    );
    -- comment 2
  up: |
    CREATE TABLE users(
      id bigint NOT NULL
    );
  down: |
    DROP TABLE `users`;
