# yaml-language-server: $schema=../../testutil/testcase.schema.json

CreateTable:
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    CREATE TABLE bigdata (
      data bigint
    );
DropTable:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
    CREATE TABLE bigdata (
      data bigint
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  up: |
    DROP TABLE `bigdata`;
  down: |
    CREATE TABLE bigdata (
      data bigint
    );
CreateTableWithImplicitNotNull:
  desired: |
    CREATE TABLE users (
      id bigint PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
CreateTableDropPrimaryKey:
  flavor: "!tidb"  # TiDB doesn't support DROP PRIMARY KEY on clustered index
  current: |
    CREATE TABLE users (
      id bigint NOT NULL PRIMARY KEY,
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(20)
    );
  up: |
    ALTER TABLE `users` DROP PRIMARY KEY;
  down: |
    ALTER TABLE `users` ADD PRIMARY KEY (`id`);
CreateTableAddPrimaryKeyInColumn:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(20) PRIMARY KEY
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(20) NOT NULL;
    ALTER TABLE `users` ADD PRIMARY KEY (`name`);
  down: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(20);
    ALTER TABLE `users` DROP PRIMARY KEY;
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(20);
CreateTableAddPrimaryKey:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(20),
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `users` ADD PRIMARY KEY (`id`);
  down: |
    ALTER TABLE `users` DROP PRIMARY KEY;
CreateTableAddAutoIncrement:
  flavor: mysql
  current: |
    CREATE TABLE users (
      id bigint(20) NOT NULL PRIMARY KEY,
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(20)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint(20) NOT NULL AUTO_INCREMENT;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint NOT NULL;
  min_version: '8.0'
AlterTableAddSetTypeColumn:
  current: |
    CREATE TABLE alarm (id BIGINT PRIMARY KEY);
  desired: |
    CREATE TABLE alarm (
      id BIGINT PRIMARY KEY,
      dayOfWeek SET('Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun') NOT NULL
    );
  up: |
    ALTER TABLE `alarm` ADD COLUMN `dayOfWeek` set('Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun') NOT NULL AFTER `id`;
  down: |
    ALTER TABLE `alarm` DROP COLUMN `dayOfWeek`;
CreateTableWithKeyBlockSize:
  desired: |
    CREATE TABLE users (
      id BIGINT
    ) KEY_BLOCK_SIZE=8;
AlterTableColumnFractionalSecondsPart:
  current: |
    CREATE TABLE users (
      id bigint(20) PRIMARY KEY,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id bigint(20) PRIMARY KEY,
      created_at datetime(3) NOT NULL
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `created_at` `created_at` datetime(3) NOT NULL;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `created_at` `created_at` datetime NOT NULL;
TableComment:
  current: |
    CREATE TABLE `prefecture` (
      `id` int(11) unsigned NOT NULL COMMENT 'ID',
      `name` varchar(50) NOT NULL COMMENT '都道府県名',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
  desired: |
    CREATE TABLE `prefecture` (
      `id` int(11) unsigned NOT NULL COMMENT 'ID',
      `name` varchar(50) NOT NULL COMMENT '都道府県名',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='都道府県マスター';
  up: |
    ALTER TABLE `prefecture` COMMENT = '都道府県マスター';
  down: |
    ALTER TABLE `prefecture` COMMENT = '';
RemoveTableComment:
  current: |
    CREATE TABLE `prefecture` (
      `id` int(11) unsigned NOT NULL COMMENT 'ID',
      `name` varchar(50) NOT NULL COMMENT '都道府県名',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='都道府県マスター';
  desired: |
    CREATE TABLE `prefecture` (
      `id` int(11) unsigned NOT NULL COMMENT 'ID',
      `name` varchar(50) NOT NULL COMMENT '都道府県名',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
  up: |
    ALTER TABLE `prefecture` COMMENT = '';
  down: |
    ALTER TABLE `prefecture` COMMENT = '都道府県マスター';
CreateTableChangePrimaryKey:
  flavor: "!tidb"  # TiDB doesn't support DROP PRIMARY KEY on clustered index
  current: |
    CREATE TABLE friends (
      user_id bigint NOT NULL PRIMARY KEY,
      friend_id bigint NOT NULL,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE friends (
      user_id bigint NOT NULL,
      friend_id bigint NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (user_id, friend_id)
    );
  up: |
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` ADD PRIMARY KEY (`user_id`, `friend_id`);
  down: |
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` ADD PRIMARY KEY (`user_id`);
CreateTableChangePrimaryKeyWithComment:
  flavor: "!tidb"  # TiDB doesn't support DROP PRIMARY KEY on clustered index
  current: |
    CREATE TABLE friends (
      user_id bigint NOT NULL PRIMARY KEY,
      friend_id bigint NOT NULL,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE friends (
      user_id bigint NOT NULL,
      friend_id bigint NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (user_id, friend_id) COMMENT 'new primary key'
    );
  up: |
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` ADD PRIMARY KEY (`user_id`, `friend_id`) COMMENT 'new primary key';
  down: |
    ALTER TABLE `friends` DROP PRIMARY KEY;
    ALTER TABLE `friends` ADD PRIMARY KEY (`user_id`);
CreateTableAddAutoIncrementPrimaryKey:
  flavor: mysql
  current: |
    CREATE TABLE users (
      name varchar(20)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL AUTO_INCREMENT,
      name varchar(20),
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `id` bigint NOT NULL FIRST;
    ALTER TABLE `users` ADD PRIMARY KEY (`id`);
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint NOT NULL AUTO_INCREMENT;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint NOT NULL;
    ALTER TABLE `users` DROP PRIMARY KEY;
    ALTER TABLE `users` DROP COLUMN `id`;
  min_version: '8.0'
CreateTableKeepAutoIncrement:
  flavor: "!tidb"  # TiDB does not allow setting AUTO_INCREMENT on existing columns
  current: |
    CREATE TABLE users (
      id int(11) NOT NULL AUTO_INCREMENT,
      password char(128) COLLATE utf8mb4_bin DEFAULT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT NOT NULL AUTO_INCREMENT,
      password char(128) COLLATE utf8mb4_bin DEFAULT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint NOT NULL AUTO_INCREMENT;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` int(11) NOT NULL AUTO_INCREMENT;
AddColumn:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `created_at` datetime NOT NULL AFTER `name`;
  down: |
    ALTER TABLE `users` DROP COLUMN `created_at`;
DropColumn:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      created_at datetime NOT NULL
    );
  up: |
    ALTER TABLE `users` DROP COLUMN `name`;
  down: |
    ALTER TABLE `users` ADD COLUMN `name` varchar(40) DEFAULT null AFTER `id`;
AddColumnAfter:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      created_at datetime NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name varchar(40) NOT NULL,
      created_at datetime NOT NULL
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `name` varchar(40) NOT NULL AFTER `id`;
  down: |
    ALTER TABLE `users` DROP COLUMN `name`;
AddColumnWithNull:
  current: |
    CREATE TABLE users (
      id bigint PRIMARY KEY,
      name varchar(40) DEFAULT NULL
    );
  desired: |
    CREATE TABLE users (
      id bigint PRIMARY KEY,
      name varchar(40) DEFAULT NULL,
      created_at timestamp NULL DEFAULT NULL
    );
  up: |
    ALTER TABLE `users` ADD COLUMN `created_at` timestamp NULL DEFAULT null AFTER `name`;
  down: |
    ALTER TABLE `users` DROP COLUMN `created_at`;
ChangeColumn:
  current: |
    CREATE TABLE users (
      id int UNSIGNED NOT NULL,
      name varchar(40)
    );
  desired: |
    CREATE TABLE users (
      id bigint UNSIGNED NOT NULL,
      name char(40)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` bigint UNSIGNED NOT NULL;
    ALTER TABLE `users` CHANGE COLUMN `name` `name` char(40);
  down: |
    ALTER TABLE `users` CHANGE COLUMN `id` `id` int UNSIGNED NOT NULL;
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(40);
ChangeColumnLength:
  flavor: "!tidb"  # TiDB has column length change handling differences
  current: |
    CREATE TABLE users (
      id int UNSIGNED NOT NULL,
      name varchar(255) COLLATE utf8mb4_bin DEFAULT NULL
    );
  desired: |
    CREATE TABLE users (
      id int UNSIGNED NOT NULL,
      name varchar(1000) COLLATE utf8mb4_bin DEFAULT NULL
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(1000) COLLATE utf8mb4_bin DEFAULT null;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(255) COLLATE utf8mb4_bin DEFAULT null;
ChangeColumnBinary:
  flavor: "!tidb"  # TiDB has collation handling differences
  current: |
    CREATE TABLE users (
      word varchar(64) NOT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
  desired: |
    CREATE TABLE users (
      word varchar(64) BINARY NOT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
  up: |
    ALTER TABLE `users` CHANGE COLUMN `word` `word` varchar(64) COLLATE utf8mb4_bin NOT NULL;
  down: ""
ChangeColumnCollate:
  flavor: "!tidb"  # TiDB doesn't support charset changes (e.g., utf8mb4 to latin1)
  current: |
    CREATE TABLE users (
      password char(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin
    );
  desired: |
    CREATE TABLE users (
      password char(128) CHARACTER SET latin1 COLLATE latin1_bin
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `password` `password` char(128) CHARACTER SET latin1 COLLATE latin1_bin;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `password` `password` char(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
ChangeEnumColumn:
  current: |
    CREATE TABLE users (
      active enum("active")
    );
  desired: |
    CREATE TABLE users (
      active enum("active", "inactive")
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `active` `active` enum('active', 'inactive');
  down: |
    ALTER TABLE `users` CHANGE COLUMN `active` `active` enum('active');
ChangeComment:
  current: |
    CREATE TABLE users (
      created_at datetime COMMENT 'created at'
    );
  desired: |
    CREATE TABLE users (
      created_at datetime COMMENT 'created time'
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `created_at` `created_at` datetime COMMENT 'created time';
  down: |
    ALTER TABLE `users` CHANGE COLUMN `created_at` `created_at` datetime COMMENT 'created at';
SwapColumn:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(40) NOT NULL,
      nickname varchar(20) NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (id)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      nickname varchar(20) NOT NULL,
      name varchar(40) NOT NULL,
      created_at datetime NOT NULL,
      PRIMARY KEY (id)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `nickname` `nickname` varchar(20) NOT NULL AFTER `id`;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(40) NOT NULL AFTER `id`;
RenameColumn:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      username text,
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      user_name text, -- @renamed from=username
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `username` `user_name` text;
  down: |
    ALTER TABLE `users` ADD COLUMN `username` text AFTER `id`;
    ALTER TABLE `users` DROP COLUMN `user_name`;
RenameColumnWithTypeChange:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      username varchar(100),
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      user_name text NOT NULL, -- @renamed from=username
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `username` `user_name` text NOT NULL;
  down: |
    ALTER TABLE `users` ADD COLUMN `username` varchar(100) AFTER `id`;
    ALTER TABLE `users` DROP COLUMN `user_name`;
RenameColumnIdempotency:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      user_name text,
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      user_name text, -- @renamed from=username
      age integer
    );
  up: ""
  down: ""

RenameColumnConflictingNames:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      username text,
      user_name varchar(50),
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      username text,
      user_name varchar(100), -- @renamed from=username
      age integer
    );
  error: "cannot rename column 'username' to 'user_name' - column 'username' still exists"

RenameColumnQuotedDoubleQuotes:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      `foo bar` text,
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      foobar text, -- @renamed from="foo bar"
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `foo bar` `foobar` text;
  down: |
    ALTER TABLE `users` ADD COLUMN `foo bar` text AFTER `id`;
    ALTER TABLE `users` DROP COLUMN `foobar`;
RenameColumnWithSpecialChars:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      `column-with-dash` varchar(50),
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      column_with_underscore varchar(50), -- @renamed from="column-with-dash"
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `column-with-dash` `column_with_underscore` varchar(50);
  down: |
    ALTER TABLE `users` ADD COLUMN `column-with-dash` varchar(50) AFTER `id`;
    ALTER TABLE `users` DROP COLUMN `column_with_underscore`;
RenameColumnWithDot:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      `special.column` text NOT NULL,
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      special_column text NOT NULL, -- @renamed from="special.column"
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `special.column` `special_column` text NOT NULL;
  down: |
    ALTER TABLE `users` ADD COLUMN `special.column` text NOT NULL AFTER `id`;
    ALTER TABLE `users` DROP COLUMN `special_column`;
RenameColumnWithCStyleComment:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      username varchar(100),
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      user_name varchar(100), /* @renamed from=username */
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `username` `user_name` varchar(100);
  down: |
    ALTER TABLE `users` ADD COLUMN `username` varchar(100) AFTER `id`;
    ALTER TABLE `users` DROP COLUMN `user_name`;
RenameMultipleColumns:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      `user name` text,
      `email@address` varchar(100),
      age integer
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      username text, -- @renamed from="user name"
      email_address varchar(100), -- @renamed from="email@address"
      age integer
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `user name` `username` text;
    ALTER TABLE `users` CHANGE COLUMN `email@address` `email_address` varchar(100);
  down: |
    ALTER TABLE `users` ADD COLUMN `user name` text AFTER `id`;
    ALTER TABLE `users` ADD COLUMN `email@address` varchar(100) AFTER `user name`;
    ALTER TABLE `users` DROP COLUMN `email_address`;
    ALTER TABLE `users` DROP COLUMN `username`;
RenameTable:
  current: |
    CREATE TABLE user_accounts (
      id bigint NOT NULL,
      username text,
      age integer
    );
  desired: |
    CREATE TABLE users ( -- @renamed from=user_accounts
      id bigint NOT NULL,
      username text,
      age integer
    );
  up: |
    ALTER TABLE `user_accounts` RENAME TO `users`;
  down: |
    CREATE TABLE user_accounts (
      id bigint NOT NULL,
      username text,
      age integer
    );
    DROP TABLE `users`;
RenameTableWithCommentVariant:
  current: |
    CREATE TABLE old_users (
      id bigint NOT NULL,
      name text
    );
  desired: |
    CREATE TABLE new_users /* @renamed from=old_users */ (
      id bigint NOT NULL,
      name text
    );
  up: |
    ALTER TABLE `old_users` RENAME TO `new_users`;
  down: |
    CREATE TABLE old_users (
      id bigint NOT NULL,
      name text
    );
    DROP TABLE `new_users`;
RenameTableWithQuotedName:
  current: |
    CREATE TABLE `user accounts` (
      id bigint NOT NULL,
      name text
    );
  desired: |
    CREATE TABLE `user_profiles` ( -- @renamed from="user accounts"
      id bigint NOT NULL,
      name text
    );
  up: |
    ALTER TABLE `user accounts` RENAME TO `user_profiles`;
  down: |
    CREATE TABLE `user accounts` (
      id bigint NOT NULL,
      name text
    );
    DROP TABLE `user_profiles`;
RenameTableAndMultipleColumnChanges:
  flavor: "!tidb"  # TiDB does not allow setting AUTO_INCREMENT on existing columns
  current: |
    CREATE TABLE old_accounts (
      id bigint NOT NULL,
      user_name varchar(50),
      is_active boolean,
      old_field text
    );
  desired: |
    CREATE TABLE accounts ( -- @renamed from=old_accounts
      id bigint NOT NULL AUTO_INCREMENT PRIMARY KEY,
      username varchar(100), -- @renamed from=user_name
      is_active boolean DEFAULT true,
      created_at timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
  up: |
    ALTER TABLE `old_accounts` RENAME TO `accounts`;
    ALTER TABLE `accounts` CHANGE COLUMN `user_name` `username` varchar(100);
    ALTER TABLE `accounts` CHANGE COLUMN `is_active` `is_active` boolean DEFAULT true;
    ALTER TABLE `accounts` ADD COLUMN `created_at` timestamp NOT NULL DEFAULT current_timestamp AFTER `is_active`;
    ALTER TABLE `accounts` ADD PRIMARY KEY (`id`);
    ALTER TABLE `accounts` CHANGE COLUMN `id` `id` bigint NOT NULL AUTO_INCREMENT;
    ALTER TABLE `accounts` DROP COLUMN `old_field`;
  down: |
    CREATE TABLE old_accounts (
      id bigint NOT NULL,
      user_name varchar(50),
      is_active boolean,
      old_field text
    );
    DROP TABLE `accounts`;
RenameIndex:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255),
      username varchar(100),
      INDEX old_email_idx (email)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255),
      username varchar(100),
      INDEX new_email_idx (email) -- @renamed from=old_email_idx
    );
  up: |
    ALTER TABLE `users` RENAME INDEX `old_email_idx` TO `new_email_idx`;
  down: |
    ALTER TABLE `users` ADD INDEX `old_email_idx` (`email`);
    ALTER TABLE `users` DROP INDEX `new_email_idx`;
RenameIndexStandalone:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255)
    );
    CREATE INDEX email_idx ON users (email);
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255)
    );
    CREATE INDEX user_email_idx /* @renamed from=email_idx */ ON users (email);
  up: |
    ALTER TABLE `users` RENAME INDEX `email_idx` TO `user_email_idx`;
  down: |
    CREATE INDEX email_idx ON users (email);
    ALTER TABLE `users` DROP INDEX `user_email_idx`;
RenameUniqueIndex:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255),
      UNIQUE KEY old_unique_email (email)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255),
      UNIQUE KEY unique_email (email) -- @renamed from=old_unique_email
    );
  up: |
    ALTER TABLE `users` RENAME INDEX `old_unique_email` TO `unique_email`;
  down: |
    ALTER TABLE `users` ADD UNIQUE KEY `old_unique_email` (`email`);
    ALTER TABLE `users` DROP INDEX `unique_email`;
RenameMultipleIndexes:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255),
      username varchar(100),
      INDEX idx_email (email),
      INDEX idx_username (username)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      email varchar(255),
      username varchar(100),
      INDEX email_idx (email), -- @renamed from=idx_email
      INDEX username_idx (username) -- @renamed from=idx_username
    );
  up: |
    ALTER TABLE `users` RENAME INDEX `idx_email` TO `email_idx`;
    ALTER TABLE `users` RENAME INDEX `idx_username` TO `username_idx`;
  down: |
    ALTER TABLE `users` ADD INDEX `idx_email` (`email`);
    ALTER TABLE `users` ADD INDEX `idx_username` (`username`);
    ALTER TABLE `users` DROP INDEX `email_idx`;
    ALTER TABLE `users` DROP INDEX `username_idx`;
RenameTableAndAddIndex:
  current: |
    CREATE TABLE old_users (
      id bigint NOT NULL,
      email varchar(100),
      username varchar(50)
    );
  desired: |
    CREATE TABLE users ( -- @renamed from=old_users
      id bigint NOT NULL,
      email varchar(100),
      username varchar(50),
      KEY email_idx (email),
      KEY username_idx (username)
    );
  up: |
    ALTER TABLE `old_users` RENAME TO `users`;
    ALTER TABLE `users` ADD KEY `email_idx` (`email`);
    ALTER TABLE `users` ADD KEY `username_idx` (`username`);
  down: |
    CREATE TABLE old_users (
      id bigint NOT NULL,
      email varchar(100),
      username varchar(50)
    );
    DROP TABLE `users`;
CreateWithNonReservedKeywordColumns:
  flavor: "!tidb"  # TiDB doesn't support triggers
  desired: |
    CREATE TABLE test (
        age INTEGER,
        definer INTEGER,
        invoker INTEGER,
        policy INTEGER,
        type INTEGER,
        status INTEGER,
        zone INTEGER
    );
    CREATE TABLE test_log (
        age INTEGER,
        definer INTEGER,
        invoker INTEGER,
        policy INTEGER,
        type INTEGER,
        status INTEGER,
        zone INTEGER
    );
    CREATE TRIGGER `test_after_insert` after insert ON `test` FOR EACH ROW begin
    insert into test_log(age, definer, invoker, policy, type, status, zone) values (NEW.age, NEW.definer, NEW.invoker, NEW.policy, NEW.type, NEW.status, NEW.zone);
    update test_log set status = NEW.status, type = NEW.type, zone = NEW.zone, policy = NEW.policy where definer = NEW.definer and invoker = NEW.invoker;
    end;

CreateTableWithFunctionalIndex:
  flavor: "!mariadb"
  # https://blogs.oracle.com/mysql/post/functional-indexes-in-mysql
  min_version: '8.0'
  desired: |
    CREATE TABLE `app_badge_tag` (
    `tag_id` varchar(255) NOT NULL,
    `badge_id` varchar(32) NOT NULL,
    `design_id` varchar(255) DEFAULT NULL,
    `color_id` varchar(255) DEFAULT NULL,
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`tag_id`),
    UNIQUE KEY `app_badge_tag_pk` (`badge_id`,((case when (`design_id` is null) then _utf8mb4'' else `design_id` end)),((case when (`color_id` is null) then _utf8mb4'' else `color_id` end))),
    KEY `app_badge_tag_design_id_index` (`design_id`)
    );
  up: |
    CREATE TABLE `app_badge_tag` (
    `tag_id` varchar(255) NOT NULL,
    `badge_id` varchar(32) NOT NULL,
    `design_id` varchar(255) DEFAULT NULL,
    `color_id` varchar(255) DEFAULT NULL,
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`tag_id`),
    UNIQUE KEY `app_badge_tag_pk` (`badge_id`,((case when (`design_id` is null) then _utf8mb4'' else `design_id` end)),((case when (`color_id` is null) then _utf8mb4'' else `color_id` end))),
    KEY `app_badge_tag_design_id_index` (`design_id`)
    );
  down: |
    DROP TABLE `app_badge_tag`;
AlterColumnSetDefault:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      status varchar(20),
      priority int
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      status varchar(20) DEFAULT 'active',
      priority int DEFAULT 1
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `status` `status` varchar(20) DEFAULT 'active';
    ALTER TABLE `users` CHANGE COLUMN `priority` `priority` int DEFAULT 1;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `status` `status` varchar(20);
    ALTER TABLE `users` CHANGE COLUMN `priority` `priority` int;
AlterColumnDropDefault:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      status varchar(20) DEFAULT 'active',
      priority int DEFAULT 1
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      status varchar(20),
      priority int
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `status` `status` varchar(20);
    ALTER TABLE `users` CHANGE COLUMN `priority` `priority` int;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `status` `status` varchar(20) DEFAULT 'active';
    ALTER TABLE `users` CHANGE COLUMN `priority` `priority` int DEFAULT 1;
AlterColumnChangeDefault:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      status varchar(20) DEFAULT 'pending',
      is_active boolean DEFAULT false
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      status varchar(20) DEFAULT 'active',
      is_active boolean DEFAULT true
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `status` `status` varchar(20) DEFAULT 'active';
    ALTER TABLE `users` CHANGE COLUMN `is_active` `is_active` boolean DEFAULT true;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `status` `status` varchar(20) DEFAULT 'pending';
    ALTER TABLE `users` CHANGE COLUMN `is_active` `is_active` boolean DEFAULT false;
AlterColumnSetNotNull:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(100),
      email varchar(255)
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(100) NOT NULL,
      email varchar(255) NOT NULL
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(100) NOT NULL;
    ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NOT NULL;
  down: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(100);
    ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255);
AlterColumnDropNotNull:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(100) NOT NULL,
      email varchar(255) NOT NULL
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(100),
      email varchar(255)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(100);
    ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255);
  down: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(100) NOT NULL;
    ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NOT NULL;
AlterColumnChangeNotNullAndDefault:
  current: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(100),
      email varchar(255) NOT NULL DEFAULT 'unknown@example.com'
    );
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(100) NOT NULL DEFAULT 'anonymous',
      email varchar(255)
    );
  up: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(100) NOT NULL DEFAULT 'anonymous';
    ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255);
  down: |
    ALTER TABLE `users` CHANGE COLUMN `name` `name` varchar(100);
    ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NOT NULL DEFAULT 'unknown@example.com';
CreateTableWithDefaultCharset:
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(40)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CreateTableWithDefaultCharacterSet:
  min_version: "8.0"
  desired: |
    CREATE TABLE users (
      id bigint NOT NULL,
      name varchar(40)
    ) ENGINE=InnoDB DEFAULT CHARACTER SET=utf8mb4;

AddColumnCheckAndIndex:
  min_version: "8.0"
  current: |
    CREATE TABLE authors (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(255) NOT NULL
    ) Engine=InnoDB DEFAULT CHARSET=utf8mb4;

    CREATE TABLE books (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title VARCHAR(255) NOT NULL,
      author_id BIGINT UNSIGNED NOT NULL,
      price DECIMAL(10, 2) NOT NULL,
      FOREIGN KEY (author_id) REFERENCES authors(id)
    ) Engine=InnoDB DEFAULT CHARSET=utf8mb4;
  desired: |
    CREATE TABLE authors (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(255) NOT NULL
    ) Engine=InnoDB DEFAULT CHARSET=utf8mb4;

    CREATE TABLE books (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title VARCHAR(255) NOT NULL,
      author_id BIGINT UNSIGNED NOT NULL,
      price DECIMAL(10, 2) NOT NULL,
      stock INT NOT NULL DEFAULT 0,
      FOREIGN KEY (author_id) REFERENCES authors(id),
      CHECK (price > 0),
      CHECK (stock >= 0),
      INDEX idx_author (author_id),
      INDEX idx_price (price)
    ) Engine=InnoDB DEFAULT CHARSET=utf8mb4;

MultipleUnnamedForeignKeys:
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(255) NOT NULL
    );

    CREATE TABLE categories (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(255) NOT NULL
    );

    CREATE TABLE tags (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(255) NOT NULL
    );

    CREATE TABLE articles (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      title VARCHAR(255) NOT NULL,
      author_id BIGINT UNSIGNED NOT NULL,
      category_id BIGINT UNSIGNED NOT NULL,
      tag_id BIGINT UNSIGNED,
      FOREIGN KEY (author_id) REFERENCES users(id),
      FOREIGN KEY (category_id) REFERENCES categories(id),
      FOREIGN KEY (tag_id) REFERENCES tags(id)
    );

# Test dropping an unnamed FK: The FK in current state has a database-generated name (e.g., posts_ibfk_1),
# but after dropping, the desired state has no FK. This verifies that column-based matching
# correctly identifies the FK to drop even when the desired schema has no FK at all.
DropUnnamedForeignKey:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      user_id BIGINT UNSIGNED,
      FOREIGN KEY (user_id) REFERENCES users(id)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      user_id BIGINT UNSIGNED
    );

# Test modifying an unnamed FK to reference a different table.
# The FK in current state references users(id), but desired references admins(id).
# This verifies that column-based matching detects the FK needs to be recreated.
ModifyUnnamedForeignKey:
  current: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE admins (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      author_id BIGINT UNSIGNED,
      FOREIGN KEY (author_id) REFERENCES users(id)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE admins (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      author_id BIGINT UNSIGNED,
      FOREIGN KEY (author_id) REFERENCES admins(id)
    );

CompositeUnnamedForeignKey:
  desired: |
    CREATE TABLE tenants (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
    );

    CREATE TABLE users (
      tenant_id BIGINT UNSIGNED NOT NULL,
      user_id BIGINT UNSIGNED NOT NULL,
      name VARCHAR(255) NOT NULL,
      PRIMARY KEY (tenant_id, user_id)
    );

    CREATE TABLE posts (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
      tenant_id BIGINT UNSIGNED NOT NULL,
      author_id BIGINT UNSIGNED NOT NULL,
      title VARCHAR(255) NOT NULL,
      FOREIGN KEY (tenant_id, author_id) REFERENCES users(tenant_id, user_id)
    );

# Table with collate on table level (works on both MySQL and MariaDB)
CollateOnTable:
  desired: |
    create table users
    (
        id   int          not null,
        name varchar(255) not null
    ) COLLATE=utf8mb4_general_ci;

UseStatement:
  desired: |
    use test_db;
    CREATE TABLE bigdata (
      data bigint
    );
