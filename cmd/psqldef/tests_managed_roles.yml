# yaml-language-server: $schema=../testutils/testcase.schema.json

ManagedRolesBasicGrant:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
  managed_roles:
    - readonly_user
  up: |
    GRANT SELECT ON TABLE "public"."users" TO "readonly_user";
  down: |
    REVOKE SELECT ON TABLE "public"."users" FROM "readonly_user";
ManagedRolesMultipleRoles:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
    GRANT SELECT, INSERT, UPDATE ON TABLE "public"."users" TO "app_user";
  managed_roles:
    - readonly_user
    - app_user
  up: |
    GRANT SELECT ON TABLE "public"."users" TO "readonly_user";
    GRANT SELECT, INSERT, UPDATE ON TABLE "public"."users" TO "app_user";
  down: |
    REVOKE INSERT, SELECT, UPDATE ON TABLE "public"."users" FROM "app_user";
    REVOKE SELECT ON TABLE "public"."users" FROM "readonly_user";
ManagedRolesIgnoreUnmanagedRole:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
    GRANT ALL PRIVILEGES ON TABLE "public"."users" TO "admin_role";
  managed_roles:
    - readonly_user
  up: |
    GRANT SELECT ON TABLE "public"."users" TO "readonly_user";
  down: |
    REVOKE SELECT ON TABLE "public"."users" FROM "readonly_user";
ManagedRolesEmptyListNoChanges:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
  managed_roles: []
  up: ""
  down: ""

ManagedRolesEmptyListIgnoresOrphans:
  # Empty managed_roles means "manage no roles", so orphaned privileges should be ignored
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  managed_roles: []
  up: ""
  down: ""

ManagedRolesAddPrivileges:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO app_user;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT, INSERT, UPDATE ON TABLE "public"."users" TO "app_user";
  managed_roles:
    - app_user
  up: |
    GRANT INSERT, UPDATE ON TABLE "public"."users" TO "app_user";
  down: |
    REVOKE INSERT, UPDATE ON TABLE "public"."users" FROM "app_user";
ManagedRolesRevoke:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT INSERT, SELECT, UPDATE ON TABLE "public"."users" TO "app_user";
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO app_user;
  managed_roles:
    - app_user
  up: |
    REVOKE INSERT, UPDATE ON TABLE "public"."users" FROM "app_user";
  down: |
    GRANT INSERT, UPDATE ON TABLE "public"."users" TO "app_user";
ManagedRolesRevokeAll:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT INSERT, SELECT, UPDATE ON TABLE "public"."users" TO "app_user";
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  managed_roles:
    - app_user
  up: |
    REVOKE INSERT, SELECT, UPDATE ON TABLE "public"."users" FROM "app_user";
  down: |
    GRANT INSERT, SELECT, UPDATE ON TABLE "public"."users" TO "app_user";
ManagedRolesPublic:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE "public"."users" TO PUBLIC;
  managed_roles:
    - PUBLIC
  up: |
    GRANT SELECT ON TABLE "public"."users" TO PUBLIC;
  down: |
    REVOKE SELECT ON TABLE "public"."users" FROM PUBLIC;
ManagedRolesAllPrivileges:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT ALL PRIVILEGES ON TABLE "public"."users" TO "admin_role";
  managed_roles:
    - admin_role
  up: |
    GRANT ALL PRIVILEGES ON TABLE "public"."users" TO "admin_role";
  down: |
    REVOKE ALL PRIVILEGES ON TABLE "public"."users" FROM "admin_role";
ManagedRolesIdempotent:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO readonly_user;
  managed_roles:
    - readonly_user
  up: ""
  down: ""

ManagedRolesOverlappingWithEnableDrop:
  # Tests that overlapping GRANT statements don't cause incorrect REVOKEs
  # user1 should retain SELECT because it's granted by the first GRANT statement
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO user1;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT, INSERT ON TABLE users TO user1, user2;
    GRANT UPDATE, DELETE ON TABLE users TO user1, user3;
  managed_roles:
    - user1
    - user2
    - user3
  up: |
    GRANT INSERT ON TABLE "public"."users" TO "user1";
    GRANT SELECT, INSERT ON TABLE "public"."users" TO "user2";
    GRANT UPDATE, DELETE ON TABLE "public"."users" TO "user1", "user3";
  down: |
    REVOKE DELETE, INSERT, UPDATE ON TABLE "public"."users" FROM "user1";
    REVOKE INSERT, SELECT ON TABLE "public"."users" FROM "user2";
    REVOKE DELETE, UPDATE ON TABLE "public"."users" FROM "user3";

ManagedRolesMultipleTables:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    CREATE TABLE posts (
      id BIGINT PRIMARY KEY,
      title VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    CREATE TABLE posts (
      id BIGINT PRIMARY KEY,
      title VARCHAR(100)
    );
    GRANT SELECT, INSERT, UPDATE ON TABLE users, posts TO app_user;
  managed_roles:
    - app_user
  up: |
    GRANT SELECT, INSERT, UPDATE ON TABLE "public"."users" TO "app_user";
    GRANT SELECT, INSERT, UPDATE ON TABLE "public"."posts" TO "app_user";
  down: |
    REVOKE INSERT, SELECT, UPDATE ON TABLE "public"."posts" FROM "app_user";
    REVOKE INSERT, SELECT, UPDATE ON TABLE "public"."users" FROM "app_user";
ManagedRolesErrorGrantOption:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    grant select on table users to readonly_user with grant option;
  managed_roles:
    - readonly_user
  error: "WITH GRANT OPTION is not supported yet"

ManagedRolesErrorCascade:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    grant select on table users to readonly_user;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    revoke select on table users from readonly_user cascade;
  managed_roles:
    - readonly_user
  error: "CASCADE/RESTRICT options are not supported yet"

ManagedRolesPartialRevokeFromAll:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT ALL PRIVILEGES ON TABLE users TO admin_role;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT, INSERT, UPDATE ON TABLE users TO admin_role;
  managed_roles:
    - admin_role
  up: |
    REVOKE DELETE, REFERENCES, TRIGGER, TRUNCATE ON TABLE "public"."users" FROM "admin_role";
  down: |
    GRANT DELETE, REFERENCES, TRIGGER, TRUNCATE ON TABLE "public"."users" TO "admin_role";
ManagedRolesSpecialCharacters:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT ON TABLE users TO "user-with-dash";
    GRANT INSERT ON TABLE users TO "user.with.dot";
    GRANT UPDATE ON TABLE users TO "user@domain.com";
  managed_roles:
    - user-with-dash
    - user.with.dot
    - user@domain.com
  up: |
    GRANT SELECT ON TABLE "public"."users" TO "user-with-dash";
    GRANT INSERT ON TABLE "public"."users" TO "user.with.dot";
    GRANT UPDATE ON TABLE "public"."users" TO "user@domain.com";
  down: |
    REVOKE SELECT ON TABLE "public"."users" FROM "user-with-dash";
    REVOKE INSERT ON TABLE "public"."users" FROM "user.with.dot";
    REVOKE UPDATE ON TABLE "public"."users" FROM "user@domain.com";
ManagedRolesMixedGrantRevoke:
  current: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT, INSERT, DELETE ON TABLE users TO app_user;
  desired: |
    CREATE TABLE users (
      id BIGINT PRIMARY KEY,
      name VARCHAR(100)
    );
    GRANT SELECT, UPDATE ON TABLE users TO app_user;
  managed_roles:
    - app_user
  up: |
    REVOKE DELETE, INSERT ON TABLE "public"."users" FROM "app_user";
    GRANT UPDATE ON TABLE "public"."users" TO "app_user";
  down: |
    REVOKE UPDATE ON TABLE "public"."users" FROM "app_user";
    GRANT INSERT, DELETE ON TABLE "public"."users" TO "app_user";
