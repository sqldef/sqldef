# yaml-language-server: $schema=../../testutil/testcase.schema.json

# Test cases for CREATE TRIGGER statements
# Each test includes the required function definition that the trigger references

CreateTriggerBeforeInsert:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION set_timestamp()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER set_created_at
      BEFORE INSERT ON users
      FOR EACH ROW EXECUTE FUNCTION set_timestamp();
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION set_timestamp()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER set_created_at before insert ON public.users FOR EACH ROW EXECUTE FUNCTION set_timestamp();
  down: |
    DROP TRIGGER set_created_at ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.set_timestamp;
CreateTriggerAfterUpdate:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION log_changes()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER log_update
      AFTER UPDATE ON users
      FOR EACH ROW EXECUTE FUNCTION log_changes();
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION log_changes()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER log_update after update ON public.users FOR EACH ROW EXECUTE FUNCTION log_changes();
  down: |
    DROP TRIGGER log_update ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.log_changes;
CreateTriggerAfterDelete:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION archive_row()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN OLD;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER archive_deleted
      AFTER DELETE ON users
      FOR EACH ROW EXECUTE FUNCTION archive_row();
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION archive_row()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN OLD;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER archive_deleted after delete ON public.users FOR EACH ROW EXECUTE FUNCTION archive_row();
  down: |
    DROP TRIGGER archive_deleted ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.archive_row;
CreateTriggerExecuteProcedure:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION validate_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER validate_user
      BEFORE INSERT ON users
      FOR EACH ROW EXECUTE PROCEDURE validate_func();
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION validate_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER validate_user before insert ON public.users FOR EACH ROW EXECUTE PROCEDURE validate_func();
  down: |
    DROP TRIGGER validate_user ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.validate_func;
CreateTriggerWithMultipleEvents:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE device_tests (
      id serial PRIMARY KEY
    );
    CREATE FUNCTION check_trigger()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER enforce_required_permit
      BEFORE INSERT OR UPDATE ON device_tests
      FOR EACH ROW EXECUTE FUNCTION check_trigger();
  up: |
    CREATE TABLE device_tests (
      id serial PRIMARY KEY
    );
    CREATE FUNCTION check_trigger()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER enforce_required_permit before insert OR update ON public.device_tests FOR EACH ROW EXECUTE FUNCTION check_trigger();
  down: |
    DROP TRIGGER enforce_required_permit ON public.device_tests;
    DROP TABLE public.device_tests;
    DROP FUNCTION public.check_trigger;
CreateTriggerWithThreeEvents:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE audit_log (
      id serial PRIMARY KEY,
      action text
    );
    CREATE FUNCTION log_all_changes()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER audit_all
      AFTER INSERT OR UPDATE OR DELETE ON audit_log
      FOR EACH ROW EXECUTE FUNCTION log_all_changes();
  up: |
    CREATE TABLE audit_log (
      id serial PRIMARY KEY,
      action text
    );
    CREATE FUNCTION log_all_changes()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER audit_all after insert OR update OR delete ON public.audit_log FOR EACH ROW EXECUTE FUNCTION log_all_changes();
  down: |
    DROP TRIGGER audit_all ON public.audit_log;
    DROP TABLE public.audit_log;
    DROP FUNCTION public.log_all_changes;
CreateTriggerWithoutForEachRow:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION notify_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER notify_change
      AFTER INSERT ON users
      EXECUTE FUNCTION notify_func();
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION notify_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER notify_change after insert ON public.users FOR EACH ROW EXECUTE FUNCTION notify_func();
  down: |
    DROP TRIGGER notify_change ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.notify_func;
CreateTriggerWithFunctionArgs:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION check_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER check_value
      BEFORE INSERT ON users
      FOR EACH ROW EXECUTE FUNCTION check_func('arg1', 'arg2');
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION check_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER check_value before insert ON public.users FOR EACH ROW EXECUTE FUNCTION check_func('arg1', 'arg2');
  down: |
    DROP TRIGGER check_value ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.check_func;
CreateMultipleTriggers:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION before_insert_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE FUNCTION after_insert_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER before_insert_trigger
      BEFORE INSERT ON users
      FOR EACH ROW EXECUTE FUNCTION before_insert_func();
    CREATE TRIGGER after_insert_trigger
      AFTER INSERT ON users
      FOR EACH ROW EXECUTE FUNCTION after_insert_func();
  up: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION before_insert_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE FUNCTION after_insert_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER before_insert_trigger before insert ON public.users FOR EACH ROW EXECUTE FUNCTION before_insert_func();
    CREATE TRIGGER after_insert_trigger after insert ON public.users FOR EACH ROW EXECUTE FUNCTION after_insert_func();
  down: |
    DROP TRIGGER after_insert_trigger ON public.users;
    DROP TRIGGER before_insert_trigger ON public.users;
    DROP TABLE public.users;
    DROP FUNCTION public.after_insert_func;
    DROP FUNCTION public.before_insert_func;
DropTrigger:
  legacy_ignore_quotes: false
  current: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION log_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER log_insert
      AFTER INSERT ON users
      FOR EACH ROW EXECUTE FUNCTION log_func();
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION log_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
  up: |
    DROP TRIGGER log_insert ON public.users;
  down: |
    CREATE TRIGGER log_insert after insert ON public.users FOR EACH ROW EXECUTE FUNCTION log_func();
ModifyTrigger:
  legacy_ignore_quotes: false
  current: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION trigger_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER log_changes
      BEFORE INSERT ON users
      FOR EACH ROW EXECUTE FUNCTION trigger_func();
  desired: |
    CREATE TABLE users (
      id serial PRIMARY KEY,
      name text
    );
    CREATE FUNCTION trigger_func()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER log_changes
      AFTER UPDATE ON users
      FOR EACH ROW EXECUTE FUNCTION trigger_func();
  up: |
    DROP TRIGGER log_changes ON public.users;
    CREATE TRIGGER log_changes after update ON public.users FOR EACH ROW EXECUTE FUNCTION trigger_func();
  down: |
    DROP TRIGGER log_changes ON public.users;
    CREATE TRIGGER log_changes before insert ON public.users FOR EACH ROW EXECUTE FUNCTION trigger_func();

CreateTriggerUpdateOfColumn:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE addresses (
      id serial PRIMARY KEY,
      street1 varchar
    );
    CREATE FUNCTION addresses_street1_titlecase()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER addresses_street1_titlecase_trigger
      BEFORE INSERT OR UPDATE OF street1 ON addresses
      FOR EACH ROW EXECUTE FUNCTION addresses_street1_titlecase();
  up: |
    CREATE TABLE addresses (
      id serial PRIMARY KEY,
      street1 varchar
    );
    CREATE FUNCTION addresses_street1_titlecase()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER addresses_street1_titlecase_trigger before insert OR update OF street1 ON public.addresses FOR EACH ROW EXECUTE FUNCTION addresses_street1_titlecase();
  down: |
    DROP TRIGGER addresses_street1_titlecase_trigger ON public.addresses;
    DROP TABLE public.addresses;
    DROP FUNCTION public.addresses_street1_titlecase;

CreateTriggerUpdateOfMultipleColumns:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE addresses (
      id serial PRIMARY KEY,
      street1 varchar,
      street2 varchar
    );
    CREATE FUNCTION addresses_update_check()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER addresses_update_trigger
      BEFORE UPDATE OF street1, street2 ON addresses
      FOR EACH ROW EXECUTE FUNCTION addresses_update_check();
  up: |
    CREATE TABLE addresses (
      id serial PRIMARY KEY,
      street1 varchar,
      street2 varchar
    );
    CREATE FUNCTION addresses_update_check()
      RETURNS TRIGGER AS
    $$
    BEGIN
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER addresses_update_trigger before update OF street1, street2 ON public.addresses FOR EACH ROW EXECUTE FUNCTION addresses_update_check();
  down: |
    DROP TRIGGER addresses_update_trigger ON public.addresses;
    DROP TABLE public.addresses;
    DROP FUNCTION public.addresses_update_check;
