# Comprehensive tests for quote-aware identifier normalization (legacy_name_normalization: false)
# These tests verify that:
# - Unquoted identifiers are normalized to lowercase
# - Quoted identifiers preserve their exact case
# - Identifiers that differ only in case are treated as distinct when quoted

# =============================================================================
# TABLE NAMES
# =============================================================================

TableQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE "Users" (id int);
  desired: |
    CREATE TABLE "Users" (id int, name text);
  output: |
    ALTER TABLE "public"."Users" ADD COLUMN name text;

TableUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE Users (id int);
  desired: |
    CREATE TABLE Users (id int, name text);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

TableQuotedVsUnquotedAreDifferent:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE "Users" (id int);
    CREATE TABLE users (id int);
  desired: |
    CREATE TABLE "Users" (id int, name text);
    CREATE TABLE users (id int, email text);
  output: |
    ALTER TABLE "public"."Users" ADD COLUMN name text;
    ALTER TABLE "public".users ADD COLUMN email text;

# =============================================================================
# COLUMN NAMES
# =============================================================================

ColumnQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users ("Name" text);
  desired: |
    CREATE TABLE users ("Name" text NOT NULL);
  output: |
    ALTER TABLE "public".users ALTER COLUMN "Name" SET NOT NULL;

ColumnUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (Name text);
  desired: |
    CREATE TABLE users (Name text NOT NULL);
  output: |
    ALTER TABLE "public".users ALTER COLUMN name SET NOT NULL;

ColumnQuotedVsUnquotedAreDifferent:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users ("Name" text, name text);
  desired: |
    CREATE TABLE users ("Name" text NOT NULL, name text NOT NULL);
  output: |
    ALTER TABLE "public".users ALTER COLUMN "Name" SET NOT NULL;
    ALTER TABLE "public".users ALTER COLUMN name SET NOT NULL;

# =============================================================================
# VIEW NAMES
# =============================================================================

ViewQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int);
    CREATE VIEW "ActiveUsers" AS SELECT * FROM users;
  desired: |
    CREATE TABLE users (id int, name text);
    CREATE VIEW "ActiveUsers" AS SELECT * FROM users;
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

ViewUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int);
    CREATE VIEW ActiveUsers AS SELECT * FROM users;
  desired: |
    CREATE TABLE users (id int, name text);
    CREATE VIEW ActiveUsers AS SELECT * FROM users;
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

# =============================================================================
# TYPE NAMES (Custom Types)
# =============================================================================

TypeQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TYPE "UserStatus" AS ENUM ('active', 'inactive');
    CREATE TABLE users (id int, status "UserStatus");
  desired: |
    CREATE TYPE "UserStatus" AS ENUM ('active', 'inactive');
    CREATE TABLE users (id int, status "UserStatus", name text);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

TypeUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TYPE UserStatus AS ENUM ('active', 'inactive');
    CREATE TABLE users (id int, status userstatus);
  desired: |
    CREATE TYPE UserStatus AS ENUM ('active', 'inactive');
    CREATE TABLE users (id int, status userstatus, name text);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

# =============================================================================
# DOMAIN NAMES
# =============================================================================

DomainQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE DOMAIN "PositiveInt" AS int CHECK (VALUE > 0);
    CREATE TABLE users (id "PositiveInt");
  desired: |
    CREATE DOMAIN "PositiveInt" AS int CHECK (VALUE > 0);
    CREATE TABLE users (id "PositiveInt", score "PositiveInt");
  output: |
    ALTER TABLE "public".users ADD COLUMN score "PositiveInt";

DomainUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE DOMAIN PositiveInt AS int CHECK (VALUE > 0);
    CREATE TABLE users (id positiveint);
  desired: |
    CREATE DOMAIN PositiveInt AS int CHECK (VALUE > 0);
    CREATE TABLE users (id positiveint, score positiveint);
  output: |
    ALTER TABLE "public".users ADD COLUMN score positiveint;

# =============================================================================
# INDEX NAMES
# =============================================================================

IndexQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int, email text);
    CREATE INDEX "EmailIndex" ON users (email);
  desired: |
    CREATE TABLE users (id int, email text, name text);
    CREATE INDEX "EmailIndex" ON users (email);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

IndexUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int, email text);
    CREATE INDEX EmailIndex ON users (email);
  desired: |
    CREATE TABLE users (id int, email text, name text);
    CREATE INDEX EmailIndex ON users (email);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

# =============================================================================
# CONSTRAINT NAMES
# =============================================================================

ConstraintQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int CONSTRAINT "PrimaryKey" PRIMARY KEY);
  desired: |
    CREATE TABLE users (id int CONSTRAINT "PrimaryKey" PRIMARY KEY, email text UNIQUE);
  output: |
    ALTER TABLE "public".users ADD COLUMN email text UNIQUE;

ConstraintUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int CONSTRAINT PrimaryKey PRIMARY KEY);
  desired: |
    CREATE TABLE users (id int CONSTRAINT PrimaryKey PRIMARY KEY, email text UNIQUE);
  output: |
    ALTER TABLE "public".users ADD COLUMN email text UNIQUE;

# =============================================================================
# SEQUENCE NAMES
# =============================================================================

SequenceQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE SEQUENCE "UserIdSeq";
    CREATE TABLE users (id int DEFAULT nextval('"UserIdSeq"'));
  desired: |
    CREATE SEQUENCE "UserIdSeq";
    CREATE TABLE users (id int DEFAULT nextval('"UserIdSeq"'), name text);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

SequenceUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE SEQUENCE UserIdSeq;
    CREATE TABLE users (id int DEFAULT nextval('useridseq'));
  desired: |
    CREATE SEQUENCE UserIdSeq;
    CREATE TABLE users (id int DEFAULT nextval('useridseq'), name text);
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

# =============================================================================
# TRIGGER NAMES
# =============================================================================

TriggerQuotedPreservesCase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int, updated_at timestamp);
    CREATE FUNCTION update_timestamp() RETURNS trigger AS $$ BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql;
    CREATE TRIGGER "UpdateTimestamp" BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION update_timestamp();
  desired: |
    CREATE TABLE users (id int, name text, updated_at timestamp);
    CREATE FUNCTION update_timestamp() RETURNS trigger AS $$ BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql;
    CREATE TRIGGER "UpdateTimestamp" BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION update_timestamp();
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

TriggerUnquotedNormalizesToLowercase:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE users (id int, updated_at timestamp);
    CREATE FUNCTION update_timestamp() RETURNS trigger AS $$ BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql;
    CREATE TRIGGER UpdateTimestamp BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION update_timestamp();
  desired: |
    CREATE TABLE users (id int, name text, updated_at timestamp);
    CREATE FUNCTION update_timestamp() RETURNS trigger AS $$ BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql;
    CREATE TRIGGER UpdateTimestamp BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION update_timestamp();
  output: |
    ALTER TABLE "public".users ADD COLUMN name text;

# =============================================================================
# MIXED SCENARIOS
# =============================================================================

MixedQuotedAndUnquoted:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE "Users" (id int);
    CREATE TABLE users (id int);
  desired: |
    CREATE TABLE "Users" ("Name" text);
    CREATE TABLE users (name text);
  output: |
    ALTER TABLE "public"."Users" ADD COLUMN "Name" text;
    ALTER TABLE "public"."Users" DROP COLUMN id;
    ALTER TABLE "public".users ADD COLUMN name text;
    ALTER TABLE "public".users DROP COLUMN id;

ComplexMixedCaseScenario:
  legacy_name_normalization: false
  offline: true
  current: |
    CREATE TABLE "UserProfiles" (
      "UserId" int,
      user_name text
    );
  desired: |
    CREATE TABLE "UserProfiles" (
      "UserId" int PRIMARY KEY,
      user_name text NOT NULL,
      "CreatedAt" timestamp DEFAULT NOW()
    );
  output: |
    ALTER TABLE "public"."UserProfiles" ADD COLUMN "CreatedAt" timestamp DEFAULT NOW();
    ALTER TABLE "public"."UserProfiles" ADD PRIMARY KEY ("UserId");
    ALTER TABLE "public"."UserProfiles" ALTER COLUMN user_name SET NOT NULL;
