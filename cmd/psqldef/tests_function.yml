# Test cases for CREATE FUNCTION statements
# See: https://github.com/sqldef/sqldef/discussions/965

# Test basic function creation without trigger (for database testing)
CreateFunctionReturnsTrigger:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE device_tests (
      id serial PRIMARY KEY,
      test_type text,
      permit text
    );
    CREATE FUNCTION check_test_type_requires_permit()
      RETURNS TRIGGER AS
    $$
    BEGIN
      IF NEW.test_type = 'required' AND NEW.permit IS NULL THEN
        RAISE EXCEPTION 'Permit is required for this status value';
      END IF;
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

# Test CREATE OR REPLACE FUNCTION with trigger
CreateOrReplaceFunctionWithTrigger:
  legacy_ignore_quotes: false
  desired: |
    CREATE TABLE device_tests (
      id serial PRIMARY KEY,
      test_type text,
      permit text
    );
    CREATE OR REPLACE FUNCTION check_test_type_requires_permit()
      RETURNS TRIGGER AS
    $$
    BEGIN
      IF NEW.test_type = 'required' AND NEW.permit IS NULL THEN
        RAISE EXCEPTION 'Permit is required for this status value';
      END IF;
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER enforce_required_permit
      BEFORE INSERT OR UPDATE ON device_tests
      FOR EACH ROW EXECUTE FUNCTION check_test_type_requires_permit();
  up: |
    CREATE TABLE device_tests (
      id serial PRIMARY KEY,
      test_type text,
      permit text
    );
    CREATE OR REPLACE FUNCTION check_test_type_requires_permit()
      RETURNS TRIGGER AS
    $$
    BEGIN
      IF NEW.test_type = 'required' AND NEW.permit IS NULL THEN
        RAISE EXCEPTION 'Permit is required for this status value';
      END IF;
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    CREATE TRIGGER enforce_required_permit before insert OR update ON public.device_tests FOR EACH ROW EXECUTE FUNCTION check_test_type_requires_permit();

  down: |
    DROP TABLE public.device_tests;
    DROP TRIGGER enforce_required_permit ON public.device_tests;
