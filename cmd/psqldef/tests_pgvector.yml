# yaml-language-server: $schema=../../testutil/testcase.schema.json

# pgvector Extension Tests
# These tests require the pgvector extension to be available in PostgreSQL

CreateVectorExtension:
  legacy_ignore_quotes: false
  desired: |
    CREATE EXTENSION vector;
  up: |
    CREATE EXTENSION vector;
  down: |
    DROP EXTENSION "vector";
  flavor: pgvector

CreateTableWithVectorColumn:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  up: |
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  down: |
    DROP TABLE items;
  flavor: pgvector

AddVectorColumn:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      name text
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      name text,
      embedding vector(384)
    );
  up: |
    ALTER TABLE items ADD COLUMN embedding vector(384);
  down: |
    ALTER TABLE items DROP COLUMN embedding;
  flavor: pgvector

DropVectorColumn:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      name text,
      embedding vector(384)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      name text
    );
  up: |
    ALTER TABLE items DROP COLUMN embedding;
  down: |
    ALTER TABLE items ADD COLUMN embedding vector(384);
  flavor: pgvector

CreateIvfflatIndex:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE INDEX idx_items_embedding ON items USING ivfflat (embedding vector_l2_ops) WITH (lists = 100);
  up: |
    CREATE INDEX idx_items_embedding ON items USING ivfflat (embedding vector_l2_ops) WITH (lists = 100);
  down: |
    DROP INDEX idx_items_embedding;
  flavor: pgvector

CreateHnswIndex:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE INDEX idx_items_hnsw ON items USING hnsw (embedding vector_l2_ops);
  up: |
    CREATE INDEX idx_items_hnsw ON items USING hnsw (embedding vector_l2_ops);
  down: |
    DROP INDEX idx_items_hnsw;
  flavor: pgvector

CreateHnswIndexWithOptions:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE INDEX idx_items_hnsw ON items USING hnsw (embedding vector_l2_ops) WITH (m = 16, ef_construction = 64);
  up: |
    CREATE INDEX idx_items_hnsw ON items USING hnsw (embedding vector_l2_ops) WITH (m = 16, ef_construction = 64);
  down: |
    DROP INDEX idx_items_hnsw;
  flavor: pgvector

CreateHnswIndexCosine:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE INDEX idx_items_cosine ON items USING hnsw (embedding vector_cosine_ops);
  up: |
    CREATE INDEX idx_items_cosine ON items USING hnsw (embedding vector_cosine_ops);
  down: |
    DROP INDEX idx_items_cosine;
  flavor: pgvector

DropVectorIndex:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE INDEX idx_items_embedding ON items USING hnsw (embedding vector_l2_ops);
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  up: |
    DROP INDEX idx_items_embedding;
  down: |
    CREATE INDEX idx_items_embedding ON items USING hnsw (embedding vector_l2_ops);
  flavor: pgvector

MultipleVectorColumns:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE documents (
      id bigserial PRIMARY KEY,
      title_embedding vector(384),
      content_embedding vector(1536)
    );
  up: |
    CREATE TABLE documents (
      id bigserial PRIMARY KEY,
      title_embedding vector(384),
      content_embedding vector(1536)
    );
  down: |
    DROP TABLE documents;
  flavor: pgvector

VectorColumnNotNull:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3) NOT NULL
    );
  up: |
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3) NOT NULL
    );
  down: |
    DROP TABLE items;
  flavor: pgvector

ChangeVectorDimension:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(384)
    );
  up: |
    ALTER TABLE items ALTER COLUMN embedding TYPE vector(384);
  down: |
    ALTER TABLE items ALTER COLUMN embedding TYPE vector(3);
  flavor: pgvector

CreateViewWithL2Distance:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE VIEW items_by_distance AS
      SELECT id, embedding <-> '[1,2,3]'::vector AS distance
      FROM items;
  up: |
    CREATE VIEW items_by_distance AS
      SELECT id, embedding <-> '[1,2,3]'::vector AS distance
      FROM items;
  down: |
    DROP VIEW items_by_distance;
  flavor: pgvector

CreateViewWithCosineDistance:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE VIEW items_by_cosine AS
      SELECT id, embedding <=> '[1,2,3]'::vector AS distance
      FROM items;
  up: |
    CREATE VIEW items_by_cosine AS
      SELECT id, embedding <=> '[1,2,3]'::vector AS distance
      FROM items;
  down: |
    DROP VIEW items_by_cosine;
  flavor: pgvector

CreateViewWithInnerProduct:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE VIEW items_by_inner_product AS
      SELECT id, embedding <#> '[1,2,3]'::vector AS negative_inner_product
      FROM items;
  up: |
    CREATE VIEW items_by_inner_product AS
      SELECT id, embedding <#> '[1,2,3]'::vector AS negative_inner_product
      FROM items;
  down: |
    DROP VIEW items_by_inner_product;
  flavor: pgvector

CreateViewWithL1Distance:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      embedding vector(3)
    );
    CREATE VIEW items_by_l1 AS
      SELECT id, embedding <+> '[1,2,3]'::vector AS l1_distance
      FROM items;
  up: |
    CREATE VIEW items_by_l1 AS
      SELECT id, embedding <+> '[1,2,3]'::vector AS l1_distance
      FROM items;
  down: |
    DROP VIEW items_by_l1;
  flavor: pgvector

# Partial index with storage options
# This test ensures WITH clause appears before WHERE clause in CREATE INDEX
# PostgreSQL syntax: CREATE INDEX ... USING method (columns) WITH (options) WHERE predicate
CreatePartialIndexWithStorageOptions:
  legacy_ignore_quotes: false
  current: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      status text,
      embedding vector(3)
    );
  desired: |
    CREATE EXTENSION vector;
    CREATE TABLE items (
      id bigserial PRIMARY KEY,
      status text,
      embedding vector(3)
    );
    CREATE INDEX idx_items_partial ON items USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100) WHERE status = 'active';
  up: |
    CREATE INDEX idx_items_partial ON items USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100) WHERE status = 'active';
  down: |
    DROP INDEX idx_items_partial;
  flavor: pgvector